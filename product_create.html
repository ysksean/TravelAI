{% extends "admin/base.html" %}

{% block title %}상품 등록{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-8 flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">상품 등록</h1>
            <p class="text-slate-500 mt-2 text-lg">여행의 가치를 높이는 매력적인 상품을 설계하세요.</p>
        </div>
        <button type="button" onclick="startAIAnalysis()"
            class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
            <i data-lucide="sparkles" size="20"></i>
            <span>AI 분석 시작</span>
        </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
        <div
            class="bg-gradient-to-r from-indigo-50 to-blue-50 border border-indigo-100 rounded-2xl p-8 flex flex-col items-center text-center shadow-sm relative overflow-hidden group h-full">
            <div
                class="absolute right-0 top-0 h-full w-1/3 bg-gradient-to-l from-indigo-100/50 to-transparent skew-x-12 pointer-events-none z-0">
            </div>
            <div
                class="w-16 h-16 bg-white rounded-2xl flex items-center justify-center shadow-sm text-indigo-600 mb-4 z-10 relative">
                <i data-lucide="sparkles" size="32"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 z-10 relative">AI 상품 자동 생성</h3>
            <p class="text-slate-600 mt-2 mb-6 text-sm z-10 relative">견적서(Excel, Word, PDF)를 업로드하면<br>AI가 상품 정보를 자동으로
                완성합니다.</p>
            <div class="w-full z-20 relative">
                <label
                    class="w-full py-3 bg-white text-indigo-600 font-bold rounded-xl shadow-sm border border-indigo-100 hover:bg-indigo-50 cursor-pointer transition-all flex items-center justify-center gap-2">
                    <i data-lucide="upload-cloud" size="20"></i>
                    <span>파일 업로드</span>
                    <input type="file" class="hidden" accept=".xlsx,.xls,.pdf,.doc,.docx" id="topQuotationInput"
                        onchange="handleFileSelect('product', this)">
                </label>

                <div id="quotationFileInfo"
                    class="hidden mt-3 p-3 bg-white border border-slate-200 rounded-xl flex items-center justify-between shadow-sm animate-pulse text-left">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div
                            class="w-10 h-10 rounded-lg bg-indigo-50 flex items-center justify-center text-indigo-600 shrink-0">
                            <i id="quotationStatusIcon" data-lucide="loader-2" class="animate-spin" size="20"></i>
                        </div>
                        <div class="flex flex-col min-w-0">
                            <span class="text-sm font-bold text-slate-800 truncate"
                                id="quotationFileName">파일이름.pdf</span>
                            <span class="text-xs text-indigo-600 font-bold" id="quotationStatusText">AI 분석 중...</span>
                        </div>
                    </div>
                    <button type="button" onclick="clearQuotationFile()"
                        class="p-2 hover:bg-slate-100 rounded-full text-slate-400 hover:text-red-500 transition-colors">
                        <i data-lucide="x" size="16"></i>
                    </button>
                </div>
            </div>
        </div>

        <div
            class="bg-gradient-to-r from-emerald-50 to-green-50 border border-emerald-100 rounded-2xl p-8 flex flex-col items-center text-center shadow-sm relative overflow-hidden group h-full">
            <div
                class="absolute right-0 top-0 h-full w-1/3 bg-gradient-to-l from-emerald-100/50 to-transparent skew-x-12 pointer-events-none z-0">
            </div>
            <div
                class="w-16 h-16 bg-white rounded-2xl flex items-center justify-center shadow-sm text-emerald-600 mb-4 z-10 relative">
                <i data-lucide="file-spreadsheet" size="32"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 z-10 relative">랜드사 가격표 분석</h3>
            <p class="text-slate-600 mt-2 mb-6 text-sm z-10 relative">가격표를 업로드하면 날짜별, 인원별 요금을<br>자동으로 추출하여 매핑합니다.</p>
            <div class="w-full z-20 relative">
<label
    class="w-full py-3 bg-white text-emerald-600 font-bold rounded-xl shadow-sm border border-emerald-100 hover:bg-emerald-50 cursor-pointer transition-all flex items-center justify-center gap-2">
    <i data-lucide="upload-cloud" size="20"></i>
    <span>파일 업로드</span>
    <input type="file" name="land_itinerary_file" class="hidden" id="landFile" accept=".xlsx,.xls,.pdf,.doc,.docx"
        onchange="handleFileSelect('price', this)">
</label>
<div id="landFileInfo"
    class="hidden mt-3 p-3 bg-white border border-slate-200 rounded-xl flex items-center justify-between shadow-sm text-left">
    <div class="flex items-center gap-3 overflow-hidden">
        <div class="w-10 h-10 rounded-lg bg-emerald-50 flex items-center justify-center text-emerald-600 shrink-0">
            <i data-lucide="file-check" size="20"></i>
        </div>
        <div class="flex flex-col min-w-0">
            <span class="text-sm font-bold text-slate-800 truncate" id="landFileName">file.xlsx</span>
            <span class="text-xs text-emerald-600 font-bold">파일 선택 완료</span>
        </div>
    </div>
    <button type="button" class="text-slate-400 hover:text-red-500" onclick="clearLandFile()"><i data-lucide="x"
            size="16"></i></button>
</div>
</div>
</div>
</div>

<form id="productForm" class="space-y-12">
                    <input type="hidden" name="save_status" id="saveStatus" value="draft">

                    <section class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                            <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                <i data-lucide="images" class="text-indigo-600" size="24"></i>
                                대표 이미지
                            </h2>
                            <span class="text-sm text-slate-400">드래그하여 순서를 변경하세요. 첫 번째 이미지가 대표 썸네일입니다.</span>
                        </div>
                        <div class="p-8">
                            <div class="border-2 border-dashed border-slate-200 rounded-xl p-10 text-center hover:border-indigo-500 hover:bg-indigo-50 transition-all cursor-pointer mb-8"
                                id="heroDropzone" onclick="document.getElementById('heroImageInput').click()">
                                <input type="file" class="hidden" multiple accept="image/*" id="heroImageInput"
                                    onchange="handleHeroImages(this)">
                                <div
                                    class="w-16 h-16 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600">
                                    <i data-lucide="upload" size="28"></i>
                                </div>
                                <p class="text-lg text-slate-700 font-medium">이미지를 이곳에 드래그하거나 클릭하세요</p>
                                <p class="text-slate-400 mt-2">고화질 이미지 권장 (최대 10장)</p>
                            </div>
                            <div id="heroImageGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
                        </div>
                    </section>

                    <section class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-200 p-6 space-y-6">
                            <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <i data-lucide="info" class="text-indigo-600" size="20"></i>
                                상품 기본 정보
                            </h2>
                            <div class="flex flex-wrap gap-3">
                                <div class="inline-flex bg-slate-100 p-1 rounded-lg">
                                    <label
                                        class="px-4 py-2 rounded-md text-sm font-medium cursor-pointer transition-all bg-white text-slate-800 shadow-sm"
                                        onclick="toggleChip(this)">
                                        <input type="radio" name="product_type" value="domestic" class="hidden"> 국내
                                    </label>
                                    <label
                                        class="px-4 py-2 rounded-md text-sm font-medium cursor-pointer transition-all text-slate-500 hover:text-slate-700"
                                        onclick="toggleChip(this)">
                                        <input type="radio" name="product_type" value="overseas" class="hidden" checked>
                                        해외
                                    </label>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-500 mb-1.5">국가 / 도시</label>
                                    <input type="text" placeholder="예: 베트남 다낭"
                                        class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all outline-none text-slate-800">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-500 mb-1.5">출발지</label>
                                    <select
                                        class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all outline-none text-slate-800 bg-white"
                                        id="departureCity">
                                        <option value="ICN/GMP">인천/서울</option>
                                        <option value="PUS">부산</option>
                                        <option value="TAE">대구</option>
                                        <option value="CJJ">청주</option>
                                        <option value="KWJ">광주</option>
                                        <option value="CJU">제주</option>
                                        <option value="YNY">양양</option>
                                        <option value="MWX">무안</option>
                                        <option value="ETC">기타</option>
                                        <option value="ALL">모두 가능</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-500 mb-1.5">상품명</label>
                                <input type="text" placeholder="고객에게 보여질 매력적인 상품명을 입력하세요"
                                    class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all outline-none text-slate-800 font-medium">
                            </div>
                            <div class="grid grid-cols-2 gap-4 bg-slate-50 p-4 rounded-xl border border-slate-100">
                                <div>
                                    <label class="block text-sm font-medium text-slate-500 mb-1.5">판매가 (1인)</label>
                                    <div class="relative">
                                        <input type="text" placeholder="0"
                                            class="price-input w-full pl-4 pr-12 py-2.5 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all outline-none text-right font-bold text-slate-800"
                                            onkeyup="formatPrice(this)">
                                        <span
                                            class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 text-sm">원</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-500 mb-1.5">입금가 (NET)</label>
                                    <div class="relative">
                                        <input type="text" placeholder="0"
                                            class="price-input w-full pl-4 pr-12 py-2.5 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all outline-none text-right font-bold text-slate-600"
                                            onkeyup="formatPrice(this)">
                                        <span
                                            class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 text-sm">원</span>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-500 mb-1.5">여행 기간</label>
                                    <div class="flex items-center gap-2">
                                        <div class="relative flex-1">
                                            <input type="number" id="nightsInput" value="3" min="0"
                                                class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all outline-none text-center font-bold text-slate-800">
                                            <span
                                                class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 text-sm">박</span>
                                        </div>
                                        <div class="relative flex-1">
                                            <input type="number" id="daysInput" value="5" min="1"
                                                class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all outline-none text-center font-bold text-slate-800">
                                            <span
                                                class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 text-sm">일</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-500 mb-1.5">행사 기간 설정</label>
                                    <div class="relative">
                                        <i data-lucide="calendar"
                                            class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"
                                            size="18"></i>
                                        <input type="text" id="dateRangePicker" placeholder="2024-07-01 ~ 2024-08-31"
                                            class="w-full pl-11 pr-4 py-2.5 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all outline-none text-slate-800 cursor-pointer bg-white">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 flex flex-col h-full">
                            <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                                <i data-lucide="calendar-days" class="text-indigo-600" size="20"></i>
                                일정 시각화
                            </h2>
                            <div class="flex-1 bg-slate-50 rounded-xl p-4 border border-slate-100 flex flex-col">
                                <div class="flex justify-between items-center mb-4 px-2">
                                    <span class="font-bold text-slate-700 text-lg" id="calendarTitle">2024년 7월</span>
                                    <div class="flex gap-1">
                                        <button type="button" class="p-1 hover:bg-slate-200 rounded"
                                            onclick="changeMonth(-1)"><i data-lucide="chevron-left"
                                                size="20"></i></button>
                                        <button type="button" class="p-1 hover:bg-slate-200 rounded"
                                            onclick="changeMonth(1)"><i data-lucide="chevron-right"
                                                size="20"></i></button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-7 gap-1 text-center mb-2">
                                    <span class="text-xs font-bold text-red-500">일</span>
                                    <span class="text-xs font-bold text-slate-500">월</span>
                                    <span class="text-xs font-bold text-slate-500">화</span>
                                    <span class="text-xs font-bold text-slate-500">수</span>
                                    <span class="text-xs font-bold text-slate-500">목</span>
                                    <span class="text-xs font-bold text-slate-500">금</span>
                                    <span class="text-xs font-bold text-blue-500">토</span>
                                </div>
                                <div id="calendarGrid" class="grid grid-cols-7 gap-1 text-sm"></div>
                            </div>
                        </div>
                    </section>

                    <section class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 bg-slate-50/50 flex items-center justify-between">
                            <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                <i data-lucide="map" class="text-indigo-600" size="24"></i>
                                상세 일정 (Timeline)
                            </h2>
                            <div class="flex items-center gap-2">
                                <button type="button" onclick="resetItinerary()"
                                    class="text-sm text-slate-500 hover:bg-slate-100 hover:text-slate-700 px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1">
                                    <i data-lucide="rotate-ccw" size="14"></i> 일정 초기화
                                </button>
                                <button type="button" id="regenerateBtn" onclick="regenerateItinerary()"
                                    class="text-sm text-indigo-600 bg-indigo-50 hover:bg-indigo-100 px-3 py-1.5 rounded-lg font-bold transition-colors flex items-center gap-1">
                                    <i data-lucide="sparkles" size="14"></i> AI 일정 재생성
                                </button>
                            </div>
                        </div>
                        <!-- 일정 옵션 선택 버튼 (탭 형태) -->
                        <div id="itineraryOptions" class="px-6 pt-4 pb-2 border-b border-slate-200 hidden">
                            <div class="flex items-center gap-2 flex-wrap">
                                <!-- 버튼들이 동적으로 생성됨 -->
                            </div>
                        </div>
                        <div id="timelineContainer" class="p-8 space-y-10"></div>
                    </section>

                    <div id="hotelContainer" class="space-y-6">
                    <section id="hotelInfoSection"
                        class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden hidden">
                        <div class="p-6 border-b border-slate-100 bg-slate-50 flex items-center gap-2">
                            <strong class="text-lg text-slate-800">4. 호텔 정보</strong>
                        </div>
                        <div class="p-6 space-y-6">
                            <div>
                                <h6
                                    class="text-indigo-600 font-bold border-b border-indigo-100 pb-2 mb-4 flex items-center gap-2">
                                    필수 정보 (Essential)</h6>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">호텔명 (한글/영문)</label>
                                        <input type="text"
                                            class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-indigo-500 outline-none"
                                            placeholder="예: 다낭 메리어트 리조트">
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-slate-700 mb-1">위치 (지역)</label>
                                            <input type="text"
                                                class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-indigo-500 outline-none"
                                                placeholder="지역명">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-slate-700 mb-1">등급</label>
                                            <select
                                                class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-indigo-500 outline-none bg-white">
                                                <option>5성급</option>
                                                <option>4성급</option>
                                                <option>3성급</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-span-full">
                                        <label class="block text-sm font-medium text-slate-700 mb-1">상세 설명 &
                                            부대시설</label>
                                        <textarea
                                            class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-indigo-500 outline-none resize-none"
                                            rows="3" placeholder="호텔 특징 및 수영장, 레스토랑 등 부대시설 입력"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-slate-50 p-5 rounded-xl border border-slate-100">
                                <h6 class="text-slate-500 font-bold border-b border-slate-200 pb-2 mb-4">부가 정보
                                    (Additional)</h6>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">체크인/아웃</label>
                                        <input type="text"
                                            class="w-full px-3 py-2 text-sm rounded-lg border border-slate-200 focus:border-indigo-500 outline-none"
                                            placeholder="15:00 / 11:00">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">공항/시내 거리</label>
                                        <input type="text"
                                            class="w-full px-3 py-2 text-sm rounded-lg border border-slate-200 focus:border-indigo-500 outline-none"
                                            placeholder="예: 15km / 20분">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">웹사이트/전화번호</label>
                                        <input type="text"
                                            class="w-full px-3 py-2 text-sm rounded-lg border border-slate-200 focus:border-indigo-500 outline-none"
                                            placeholder="웹사이트/전화번호">
                                    </div>
                                    <div class="col-span-full">
                                        <label class="block text-xs font-bold text-slate-500 mb-1">유의사항 및 추가정보</label>
                                        <input type="text"
                                            class="w-full px-3 py-2 text-sm rounded-lg border border-slate-200 focus:border-indigo-500 outline-none"
                                            placeholder="추가 참고사항 입력">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                    </div>

                    <div id="golfContainer" class="space-y-6">
                    <section id="golfInfoSection"
                        class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden hidden">
                        <div class="p-6 border-b border-slate-100 bg-slate-50 flex items-center gap-2">
                            <strong class="text-lg text-slate-800">5. 골프장 정보</strong>
                        </div>
                        <div class="p-6 space-y-6">
                            <div>
                                <h6 class="text-green-600 font-bold border-b border-green-100 pb-2 mb-4">필수 정보
                                    (Essential)</h6>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">골프장명
                                            (한글/현지)</label>
                                        <input type="text"
                                            class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-indigo-500 outline-none"
                                            placeholder="골프장명">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">주소</label>
                                        <input type="text"
                                            class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-indigo-500 outline-none"
                                            placeholder="주소">
                                    </div>
                                    <div class="col-span-full">
                                        <label class="block text-sm font-medium text-slate-700 mb-1">운영 정보</label>
                                        <input type="text"
                                            class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-indigo-500 outline-none"
                                            placeholder="티오프 간격, 카트/캐디 운영 정책 등">
                                    </div>
                                    <div class="col-span-full">
                                        <label class="block text-sm font-medium text-slate-700 mb-1">골프장 설명</label>
                                        <textarea
                                            class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-indigo-500 outline-none resize-none"
                                            rows="2" placeholder="골프장 설명 (바다와 맞닿은 아름다운 코스 등)"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-slate-50 p-5 rounded-xl border border-slate-100">
                                <h6 class="text-slate-500 font-bold border-b border-slate-200 pb-2 mb-4">부가 정보
                                    (Additional)</h6>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">웹사이트/전화번호</label>
                                        <input type="text"
                                            class="w-full px-3 py-2 text-sm rounded-lg border border-slate-200 focus:border-indigo-500 outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">홀 정보</label>
                                        <input type="text"
                                            class="w-full px-3 py-2 text-sm rounded-lg border border-slate-200 focus:border-indigo-500 outline-none"
                                            placeholder="18홀/72파/6912Y">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                    </div>

                    <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8">
                        <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                            <i data-lucide="list-checks" class="text-indigo-600" size="24"></i>
                            상품 상세 정보
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">포함 사항</label>
                                <textarea
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-indigo-500 outline-none resize-none"
                                    rows="4" placeholder="- 왕복 항공권&#10;- 전 일정 호텔 숙박 (2인 1실)&#10;- 일정표 상의 식사"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">불포함 사항</label>
                                <textarea
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-indigo-500 outline-none resize-none"
                                    rows="4"
                                    placeholder="- 가이드/기사 경비 (1인 $40)&#10;- 개인 경비 및 매너팁&#10;- 선택 관광 비용"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">항공 정보</label>
                                <input type="text"
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-indigo-500 outline-none"
                                    placeholder="예: 대한항공 KE463 18:00 출발">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">기타 특이사항</label>
                                <input type="text"
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-indigo-500 outline-none"
                                    placeholder="쇼핑 3회, 선택관광 정보 등">
                            </div>
                        </div>
                    </section>

                    <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8">
                        <div class="flex items-center justify-between mb-8">
                            <div>
                                <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                    <i data-lucide="layout-template" class="text-indigo-600" size="24"></i>
                                    상세 콘텐츠 에디터
                                </h2>
                                <p class="text-slate-500 mt-1">텍스트와 이미지를 자유롭게 배치하여 상품 상세 페이지를 완성하세요.</p>
                            </div>
                            <button type="button" id="aiContentBtn" onclick="generateAIContent()"
                                class="px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-md hover:shadow-lg transition-all flex items-center gap-2">
                                <i data-lucide="sparkles" size="18"></i>
                                <span>AI 내용 자동 생성</span>
                            </button>
                        </div>
                        <div id="editorBlocks" class="space-y-6 mb-8 min-h-[150px]">
                            <div
                                class="editor-block group relative bg-white border border-slate-200 rounded-xl p-6 hover:border-indigo-300 transition-colors shadow-sm">
                                <div
                                    class="absolute right-3 top-3 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button type="button"
                                        class="p-2 text-slate-400 hover:text-red-500 rounded-full hover:bg-slate-100"
                                        onclick="removeBlock(this)"><i data-lucide="trash-2" size="18"></i></button>
                                </div>
                                <textarea
                                    class="w-full border-none focus:ring-0 resize-none text-slate-700 placeholder:text-slate-300 text-lg leading-relaxed"
                                    rows="3" placeholder="여기에 상세 내용을 입력하세요..."></textarea>
                            </div>
                        </div>
                        <div class="flex justify-center gap-4 border-t border-slate-100 pt-8">
                            <button type="button" onclick="addTextBlock()"
                                class="flex items-center gap-2 px-6 py-3 bg-white border border-slate-200 rounded-xl text-slate-600 hover:bg-slate-50 hover:text-indigo-600 hover:border-indigo-200 transition-all shadow-sm font-medium">
                                <i data-lucide="type" size="20"></i>
                                <span>텍스트 추가</span>
                            </button>
                            <button type="button" onclick="addImageBlock()"
                                class="flex items-center gap-2 px-6 py-3 bg-white border border-slate-200 rounded-xl text-slate-600 hover:bg-slate-50 hover:text-indigo-600 hover:border-indigo-200 transition-all shadow-sm font-medium">
                                <i data-lucide="image" size="20"></i>
                                <span>이미지 추가</span>
                            </button>
                        </div>
                    </section>

                    <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8">
                        <div class="flex items-center justify-between mb-8">
                            <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                <i data-lucide="shield-check" class="text-indigo-600" size="24"></i>
                                약관 및 규정
                            </h2>
                            <button type="button"
                                class="text-sm text-indigo-600 hover:text-indigo-700 font-bold flex items-center gap-2 bg-indigo-50 px-4 py-2 rounded-lg transition-colors"
                                onclick="fillAllPolicies()">
                                <i data-lucide="folder-open" size="16"></i>
                                기본 규정 불러오기
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-3">안전수칙 및 유의사항</label>
                                <textarea id="safetyPolicy"
                                    class="w-full px-5 py-4 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all outline-none text-slate-700 placeholder:text-slate-300 min-h-[200px] leading-relaxed"
                                    placeholder="여행 안전 수칙을 입력하세요"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-3">취소 및 환불 규정</label>
                                <textarea id="refundPolicy"
                                    class="w-full px-5 py-4 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all outline-none text-slate-700 placeholder:text-slate-300 min-h-[200px] leading-relaxed"
                                    placeholder="취소 및 환불 규정을 입력하세요"></textarea>
                            </div>
                        </div>
                    </section>
                    </form>
            </div>

            <div
                class="fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur-md border-t border-slate-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-50">
                <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
                    <div class="text-sm text-slate-500 flex items-center gap-2">
                        <i data-lucide="info" size="16"></i>
                        <span>작성 중인 내용은 자동 저장됩니다.</span>
                    </div>
                    <div class="flex gap-3">
                        <button type="button" onclick="submitForm('draft')"
                            class="px-6 py-2.5 text-slate-700 bg-white border border-slate-200 rounded-xl hover:bg-slate-50 font-semibold transition-all shadow-sm">
                            임시저장
                        </button>
                        <button type="button" onclick="submitForm('published')"
                            class="px-6 py-2.5 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 font-semibold shadow-md hover:shadow-lg transition-all flex items-center gap-2">
                            <i data-lucide="check" size="18"></i>
                            <span>상품 게시</span>
                        </button>
                    </div>
                </div>
            </div>

            <div id="loadingOverlay"
                class="fixed inset-0 z-[70] hidden flex flex-col items-center justify-center bg-black/60 backdrop-blur-sm transition-opacity duration-300">
                <div class="bg-white p-8 rounded-3xl shadow-2xl flex flex-col items-center text-center max-w-sm mx-4">
                    <div class="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mb-6 relative">
                        <i data-lucide="loader-2" class="w-10 h-10 text-indigo-600 animate-spin"></i>
                        <div class="absolute inset-0 border-4 border-indigo-100 rounded-full animate-ping opacity-20">
                        </div>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">AI가 상품을 분석 중입니다</h3>
                    <p class="text-slate-500 text-sm leading-relaxed">
                        업로드하신 견적서와 가격표를 분석하여<br>
                        최적의 상품 정보를 생성하고 있습니다.<br>
                        잠시만 기다려주세요.
                    </p>
                </div>
            </div>

            <div id="statusModal"
                class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm opacity-0 transition-opacity duration-300">
                <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full transform scale-95 transition-transform duration-300"
                    id="modalContent">
                </div>
            </div>

            <template id="daySectionTemplate">
                <div class="day-section relative pl-8 border-l-2 border-indigo-100 ml-4 pb-8 last:border-l-0 last:pb-0">
                    <span
                        class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-indigo-600 ring-4 ring-indigo-50"></span>
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-xl text-slate-800 day-title">Day 1</h3>
                        <button type="button" class="text-slate-400 hover:text-indigo-600 transition-colors"
                            onclick="toggleDayVisibility(this)"><i data-lucide="chevron-down" size="20"></i></button>
                    </div>
                    <div class="event-list space-y-3 min-h-[50px]"></div>
                    <div class="mt-4 relative">
                        <button type="button"
                            class="add-event-btn flex items-center gap-2 text-sm font-bold text-indigo-600 bg-indigo-50 hover:bg-indigo-100 px-4 py-2 rounded-lg transition-colors"
                            onclick="showTypeSelector(this)">
                            <i data-lucide="plus" size="16"></i> 일정 추가
                        </button>
                        <div
                            class="type-selector hidden absolute top-10 left-0 bg-white border border-slate-200 shadow-xl rounded-xl p-2 z-20 w-64 grid grid-cols-2 gap-1">
                            <button type="button" onclick="addEvent(this, 'flight')"
                                class="flex items-center gap-2 px-3 py-2 hover:bg-slate-50 rounded-lg text-sm text-slate-700 font-medium text-left"><span
                                    class="text-lg">✈️</span> 항공</button>
                            <button type="button" onclick="addEvent(this, 'golf')"
                                class="flex items-center gap-2 px-3 py-2 hover:bg-slate-50 rounded-lg text-sm text-slate-700 font-medium text-left"><span
                                    class="text-lg">⛳</span> 골프</button>
                            <button type="button" onclick="addEvent(this, 'hotel')"
                                class="flex items-center gap-2 px-3 py-2 hover:bg-slate-50 rounded-lg text-sm text-slate-700 font-medium text-left"><span
                                    class="text-lg">🏨</span> 호텔</button>
                            <button type="button" onclick="addEvent(this, 'sightseeing')"
                                class="flex items-center gap-2 px-3 py-2 hover:bg-slate-50 rounded-lg text-sm text-slate-700 font-medium text-left"><span
                                    class="text-lg">📷</span> 관광</button>
                            <button type="button" onclick="addEvent(this, 'meal')"
                                class="flex items-center gap-2 px-3 py-2 hover:bg-slate-50 rounded-lg text-sm text-slate-700 font-medium text-left"><span
                                    class="text-lg">🍽️</span> 식사</button>
                            <button type="button" onclick="addEvent(this, 'other')"
                                class="flex items-center gap-2 px-3 py-2 hover:bg-slate-50 rounded-lg text-sm text-slate-700 font-medium text-left"><span
                                    class="text-lg">📝</span> 기타</button>
                        </div>
                    </div>
                </div>
            </template>

            <template id="golfContent">
                <div class="mode-search relative">
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"
                            size="16"></i>
                        <input type="text"
                            class="search-input w-full pl-9 pr-20 py-2 text-sm border border-slate-200 rounded-lg focus:border-indigo-500 outline-none"
                            placeholder="골프장 검색 (예: 다낭 CC)" onkeyup="handleSearch(this)">
                        <button type="button"
                            class="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-indigo-600 font-bold hover:underline"
                            onclick="toggleMode(this)">직접 입력</button>
                    </div>
                    <div
                        class="search-results hidden absolute top-full left-0 w-full bg-white border border-slate-200 rounded-lg shadow-lg mt-1 z-10 max-h-48 overflow-y-auto">
                    </div>
                    <div class="preview-card hidden mt-3 bg-slate-50 rounded-lg p-3 flex gap-3 border border-slate-200">
                        <img src="" class="w-16 h-16 rounded-md object-cover bg-slate-200">
                        <div>
                            <div class="font-bold text-slate-800 text-sm preview-name"></div>
                            <div class="text-xs text-slate-500 preview-desc mt-1"></div>
                            <div class="text-xs text-slate-400 preview-loc mt-0.5 flex items-center gap-1"><i
                                    data-lucide="map-pin" size="10"></i> <span></span></div>
                        </div>
                    </div>
                </div>
                <div class="mode-manual hidden space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-bold text-slate-500">골프장 정보 입력</span>
                        <button type="button" class="text-xs text-indigo-600 font-bold hover:underline"
                            onclick="toggleMode(this)">DB 검색으로 전환</button>
                    </div>

                    <div>
                        <h6 class="text-green-600 font-bold border-b border-green-100 pb-2 mb-3 text-sm">필수 정보
                            (Essential)</h6>
                        <div class="grid grid-cols-1 gap-3">
                            <div class="flex gap-2">
                                <input type="text"
                                    class="flex-1 px-3 py-2 text-sm border border-slate-200 rounded-lg focus:border-indigo-500 outline-none"
                                    placeholder="골프장명 (한글/현지)">
                                <label
                                    class="px-3 py-2 border border-slate-200 rounded-lg bg-white text-slate-500 text-sm cursor-pointer hover:bg-slate-50 flex items-center gap-1 shrink-0">
                                    <i data-lucide="image" size="14"></i> 사진
                                    <input type="file" class="hidden" multiple accept="image/*"
                                        onchange="handleCardImages(this)">
                                </label>
                            </div>
                            <div class="card-image-grid grid grid-cols-4 gap-2"></div>
                            <input type="text"
                                class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:border-indigo-500 outline-none"
                                placeholder="위치">
                            <textarea
                                class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:border-indigo-500 outline-none resize-none"
                                rows="3" placeholder="운영 정보 (티오프, 카트 등)"></textarea>
                        </div>
                    </div>

                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                        <h6 class="text-slate-500 font-bold border-b border-slate-200 pb-2 mb-3 text-sm">부가 정보
                            (Additional)</h6>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text"
                                class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:border-indigo-500 outline-none"
                                placeholder="웹사이트/전화번호">
                            <input type="text"
                                class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:border-indigo-500 outline-none"
                                placeholder="상세 정보 (코스 등)">
                        </div>
                    </div>
                </div>
            </template>

            <template id="imageBlockTemplate">
                <div
                    class="editor-block group relative bg-white border border-slate-200 rounded-xl p-6 hover:border-indigo-300 transition-colors shadow-sm">
                    <div class="absolute right-3 top-3 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                        <button type="button"
                            class="p-2 text-slate-400 hover:text-red-500 rounded-full bg-white shadow-sm"
                            onclick="removeBlock(this)"><i data-lucide="trash-2" size="18"></i></button>
                    </div>
                    <div class="flex flex-col items-center justify-center border-2 border-dashed border-slate-200 rounded-xl p-8 hover:bg-slate-50 cursor-pointer transition-colors mb-4"
                        onclick="this.querySelector('input').click()">
                        <i data-lucide="image-plus" class="text-slate-400 mb-3" size="32"></i>
                        <span class="text-slate-600 font-medium">이미지 추가 (다중 선택 가능)</span>
                        <input type="file" class="hidden" multiple accept="image/*" onchange="addImagesToBlock(this)">
                    </div>
                    <div class="image-grid grid grid-cols-3 md:grid-cols-5 gap-4"></div>
                </div>
            </template>

            <template id="textBlockTemplate">
                <div
                    class="editor-block group relative bg-white border border-slate-200 rounded-xl p-6 hover:border-indigo-300 transition-colors shadow-sm">
                    <div class="absolute right-3 top-3 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button type="button"
                            class="p-2 text-slate-400 hover:text-red-500 rounded-full hover:bg-slate-100"
                            onclick="removeBlock(this)"><i data-lucide="trash-2" size="18"></i></button>
                    </div>
                    <textarea
                        class="w-full border-none focus:ring-0 resize-none text-slate-700 placeholder:text-slate-300 text-lg leading-relaxed"
                        rows="3" placeholder="여기에 상세 내용을 입력하세요."></textarea>
                </div>
            </template>

            <template id="hotelContent">
                <div class="mode-search relative">
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"
                            size="16"></i>
                        <input type="text"
                            class="search-input w-full pl-9 pr-20 py-2 text-sm border border-slate-200 rounded-lg focus:border-indigo-500 outline-none"
                            placeholder="호텔 검색 (예: 하얏트 리젠시)" onkeyup="handleSearch(this)">
                        <button type="button"
                            class="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-indigo-600 font-bold hover:underline"
                            onclick="toggleMode(this)">직접 입력</button>
                    </div>
                    <div
                        class="search-results hidden absolute top-full left-0 w-full bg-white border border-slate-200 rounded-lg shadow-lg mt-1 z-10 max-h-48 overflow-y-auto">
                    </div>
                    <div class="preview-card hidden mt-3 bg-slate-50 rounded-lg p-3 flex gap-3 border border-slate-200">
                        <img src="" class="w-16 h-16 rounded-md object-cover bg-slate-200">
                        <div>
                            <div class="font-bold text-slate-800 text-sm preview-name"></div>
                            <div class="text-xs text-slate-500 preview-desc mt-1"></div>
                            <div class="text-xs text-slate-400 preview-loc mt-0.5 flex items-center gap-1"><i
                                    data-lucide="map-pin" size="10"></i> <span></span></div>
                        </div>
                    </div>
                </div>
                <div class="mode-manual hidden space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-bold text-slate-500">호텔 정보 입력</span>
                        <button type="button" class="text-xs text-indigo-600 font-bold hover:underline"
                            onclick="toggleMode(this)">DB 검색으로 전환</button>
                    </div>

                    <div>
                        <h6 class="text-indigo-600 font-bold border-b border-indigo-100 pb-2 mb-3 text-sm">필수 정보
                            (Essential)
                        </h6>
                        <div class="grid grid-cols-1 gap-3">
                            <div class="flex gap-2">
                                <input type="text"
                                    class="flex-1 px-3 py-2 text-sm border border-slate-200 rounded-lg focus:border-indigo-500 outline-none"
                                    placeholder="호텔명 (한글/영문)">
                                <label
                                    class="px-3 py-2 border border-slate-200 rounded-lg bg-white text-slate-500 text-sm cursor-pointer hover:bg-slate-50 flex items-center gap-1 shrink-0">
                                    <i data-lucide="image" size="14"></i> 사진
                                    <input type="file" class="hidden" multiple accept="image/*"
                                        onchange="handleCardImages(this)">
                                </label>
                            </div>
                            <div class="card-image-grid grid grid-cols-4 gap-2"></div>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text"
                                    class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:border-indigo-500 outline-none"
                                    placeholder="위치 (지역)">
                                <select
                                    class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:border-indigo-500 outline-none bg-white">
                                    <option>5성급</option>
                                    <option>4성급</option>
                                    <option>3성급</option>
                                </select>
                            </div>
                            <textarea
                                class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:border-indigo-500 outline-none resize-none"
                                rows="3" placeholder="호텔 특징 및 부대시설"></textarea>
                        </div>
                    </div>

                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                        <h6 class="text-slate-500 font-bold border-b border-slate-200 pb-2 mb-3 text-sm">부가 정보
                            (Additional)</h6>
                        <div class="grid grid-cols-3 gap-2">
                            <input type="text"
                                class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:border-indigo-500 outline-none"
                                placeholder="체크인/아웃">
                            <input type="text"
                                class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:border-indigo-500 outline-none"
                                placeholder="공항/시내 거리">
                            <input type="text"
                                class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:border-indigo-500 outline-none"
                                placeholder="웹사이트">
                        </div>
                        <input type="text"
                            class="w-full mt-2 px-3 py-2 text-sm border border-slate-200 rounded-lg focus:border-indigo-500 outline-none"
                            placeholder="유의사항 및 추가정보">
                    </div>
                </div>
            </template>

            <template id="flightContent">
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text"
                            class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:border-indigo-500 outline-none"
                            placeholder="항공편명 (예: KE463)">
                        <input type="text"
                            class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:border-indigo-500 outline-none"
                            placeholder="출발 시간 (예: 18:05)">
                    </div>
                    <div class="flex gap-2">
                        <input type="text"
                            class="flex-1 px-3 py-2 text-sm border border-slate-200 rounded-lg focus:border-indigo-500 outline-none"
                            placeholder="출발지">
                        <span class="text-slate-400 self-center">→</span>
                        <input type="text"
                            class="flex-1 px-3 py-2 text-sm border border-slate-200 rounded-lg focus:border-indigo-500 outline-none"
                            placeholder="도착지">
                    </div>
                </div>
            </template>

            <template id="hybridContent">
                <div class="mode-search relative">
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"
                            size="16"></i>
                        <input type="text"
                            class="search-input w-full pl-9 pr-20 py-2 text-sm border border-slate-200 rounded-lg focus:border-indigo-500 outline-none"
                            placeholder="관광지 검색" onkeyup="handleSearch(this)">
                        <button type="button"
                            class="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-indigo-600 font-bold hover:underline"
                            onclick="toggleMode(this)">직접 입력</button>
                    </div>
                    <div
                        class="search-results hidden absolute top-full left-0 w-full bg-white border border-slate-200 rounded-lg shadow-lg mt-1 z-10 max-h-48 overflow-y-auto">
                    </div>
                    <div class="preview-card hidden mt-3 bg-slate-50 rounded-lg p-3 flex gap-3 border border-slate-200">
                        <img src="" class="w-16 h-16 rounded-md object-cover bg-slate-200">
                        <div>
                            <div class="font-bold text-slate-800 text-sm preview-name"></div>
                            <div class="text-xs text-slate-500 preview-desc mt-1"></div>
                            <div class="text-xs text-slate-400 preview-loc mt-0.5 flex items-center gap-1"><i
                                    data-lucide="map-pin" size="10"></i> <span></span></div>
                        </div>
                    </div>
                </div>
                <div class="mode-manual hidden space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-bold text-slate-500">관광지 정보 입력</span>
                        <button type="button" class="text-xs text-indigo-600 font-bold hover:underline"
                            onclick="toggleMode(this)">DB 검색으로 전환</button>
                    </div>
                    <div class="flex gap-2">
                        <input type="text"
                            class="flex-1 px-3 py-2 text-sm border border-slate-200 rounded-lg focus:border-indigo-500 outline-none"
                            placeholder="관광지명">
                        <label
                            class="px-3 py-2 border border-slate-200 rounded-lg bg-white text-slate-500 text-sm cursor-pointer hover:bg-slate-50 flex items-center gap-1 shrink-0">
                            <i data-lucide="image" size="14"></i> 사진
                            <input type="file" class="hidden" multiple accept="image/*"
                                onchange="handleCardImages(this)">
                        </label>
                    </div>
                    <div class="card-image-grid grid grid-cols-4 gap-2"></div>
                    <textarea
                        class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:border-indigo-500 outline-none resize-none"
                        rows="2" placeholder="상세 설명"></textarea>
                </div>
            </template>

{% endblock %}

{% block scripts %}
<script>
console.log("Product Create Script Loaded");

// ==========================================
// 1. [핵심] 파일 업로드 & 데이터 매핑 핸들러 (Backend 연동)
// ==========================================
let selectedProductFile = null;
let selectedPriceFile = null;
let selectedDateData = null; // 현재 선택된 날짜의 price_info 데이터
window.allItineraryOptions = []; // AI가 찾은 모든 일정 옵션 저장용

window.handleFileSelect = function(type, input) {
    try {
        const file = input.files[0];
        if (!file) return;

        // 📂 파일 선택 디버깅 로그
        console.log(`📂 File selected: ${type}, Name: ${file.name}, Size: ${(file.size / 1024).toFixed(2)} KB`);

        if (type === 'product') {
            selectedProductFile = file;
            const infoDiv = document.getElementById('quotationFileInfo');
            const fileNameSpan = document.getElementById('quotationFileName');
            const statusText = document.getElementById('quotationStatusText');
            const statusIcon = document.getElementById('quotationStatusIcon');

            infoDiv.classList.remove('hidden', 'bg-red-50', 'border-red-100', 'bg-green-50', 'border-green-100', 'animate-pulse');
            infoDiv.classList.add('bg-white', 'border-slate-200');
            fileNameSpan.textContent = file.name;
            statusText.textContent = "분석 대기 중";
            statusText.className = "text-xs text-slate-500 font-bold";
            statusIcon.setAttribute('data-lucide', 'file-text');
            statusIcon.classList.remove('animate-spin', 'text-indigo-600', 'text-green-600', 'text-red-600');
            statusIcon.classList.add('text-slate-400');
            if (window.lucide) lucide.createIcons();
        } else if (type === 'price') {
            selectedPriceFile = file;
            const infoDiv = document.getElementById('landFileInfo');
            const fileNameSpan = document.getElementById('landFileName');
            if (infoDiv) {
                infoDiv.classList.remove('hidden');
                fileNameSpan.textContent = file.name;
            }
        }
    } catch (error) {
        console.error("❌ File selection error:", error);
    }
}

window.startAIAnalysis = async function() {
    console.log("🚀 startAIAnalysis called");
    
    if (!selectedProductFile) {
        alert("상품 견적서 파일을 먼저 선택해주세요.");
        return;
    }

    // 🚀 API 요청 직전 디버깅 로그
    console.log(`🚀 Sending request... (Files: Product=[${selectedProductFile ? 'O' : 'X'}], Price=[${selectedPriceFile ? 'O' : 'X'}])`);

    const overlay = document.getElementById('loadingOverlay');
    if (overlay) overlay.classList.remove('hidden');

    const infoDiv = document.getElementById('quotationFileInfo');
    const statusText = document.getElementById('quotationStatusText');
    const statusIcon = document.getElementById('quotationStatusIcon');

    if (infoDiv) {
        infoDiv.classList.remove('bg-white', 'border-slate-200');
        infoDiv.classList.add('bg-indigo-50', 'border-indigo-100', 'animate-pulse');
        statusText.textContent = "AI 분석 중...";
        statusText.className = "text-xs text-indigo-600 font-bold";
        statusIcon.setAttribute('data-lucide', 'loader-2');
        statusIcon.classList.add('animate-spin', 'text-indigo-600');
        statusIcon.classList.remove('text-slate-400');
        if (window.lucide) lucide.createIcons();
    }

    try {
        const formData = new FormData();
        formData.append('product_file', selectedProductFile);
        if (selectedPriceFile) {
            formData.append('price_file', selectedPriceFile);
        }

        const response = await fetch('/product/analyze', {
            method: 'POST',
            body: formData
        });

        // 📩 API 응답 수신 디버깅 로그
        console.log(`📩 Server Response: ${response.status} ${response.statusText}`);

        const result = await response.json();
        
        // 📦 데이터 수신 확인 디버깅 로그
        console.log("📦 Raw JSON Data:", result);

        if (!response.ok) throw new Error(result.message || "Server Error");

        if (result.status === 'success' || result.data) {
            const data = result.data || result;
            console.log("✅ Parsed Data Object:", data);

            // === [HTML Mapping Start] ===
            console.log("📍 Mapping Basic Info...");
            
            // 1. 기본 및 위치 정보
            if (data.product_info?.product_name) {
                setValByPlaceholder("고객에게 보여질 매력적인 상품명을 입력하세요", data.product_info.product_name);
                console.log(`  ✓ Product Name: ${data.product_info.product_name}`);
            }

            const country = data.location_info?.country || '';
            const city = data.location_info?.city || '';
            if (country || city) {
                const locationStr = `${country} ${city}`.trim();
                setValByPlaceholder("예: 베트남 다낭", locationStr);
                console.log(`  ✓ Location: ${locationStr}`);
            }

            if (data.location_info?.departure_port) {
                const portSelect = document.getElementById('departureCity');
                let portValue = data.location_info.departure_port;
                // 출발지 매핑: '인천' -> 'ICN/GMP'
                if (portValue === '인천' || portValue.includes('인천')) {
                    portValue = 'ICN/GMP';
                }
                if (portSelect) {
                    portSelect.value = portValue;
                    console.log(`  ✓ Departure Port: ${portValue}`);
                }
            }

            if (data.basic_info?.product_type) {
                const pType = data.basic_info.product_type.includes("국내") ? "domestic" : "overseas";
                const radio = document.querySelector(`input[name="product_type"][value="${pType}"]`);
                if (radio) {
                    radio.checked = true;
                    toggleChip(radio.closest('label'));
                    console.log(`  ✓ Product Type: ${pType}`);
                }
            }

            // 2. 가격 및 일정 (첫 번째 항목 기준)
            console.log("💰 Mapping Price Info & Calendar...");
            if (data.price_info && data.price_info.length > 0) {
                const firstPrice = data.price_info[0];
                console.log(`  ✓ First Price Data:`, firstPrice);

                if (firstPrice.night_count) {
                    document.getElementById('nightsInput').value = firstPrice.night_count;
                    console.log(`  ✓ Nights: ${firstPrice.night_count}`);
                }
                if (firstPrice.day_count) {
                    document.getElementById('daysInput').value = firstPrice.day_count;
                    console.log(`  ✓ Days: ${firstPrice.day_count}`);
                }

                const priceInputs = document.querySelectorAll('.price-input');
                if (priceInputs.length >= 2 && firstPrice.price_adult) {
                    const price = parseInt(firstPrice.price_adult);
                    priceInputs[0].value = price.toLocaleString();
                    priceInputs[1].value = Math.floor(price * 0.9).toLocaleString();
                    console.log(`  ✓ Price: ${price.toLocaleString()}원`);
                }

                window.currentPriceData = data.price_info;
                selectedDateData = firstPrice; // 첫 번째 날짜 데이터를 기본 선택

                // 달력 자동 이동 (첫 출발일 기준)
                if (firstPrice.departure_date) {
                    const [y, m, d] = firstPrice.departure_date.split('-').map(Number);
                    window.currentDate = new Date(y, m - 1, 1);
                    console.log(`  ✓ Calendar moved to: ${y}년 ${m}월`);
                }
                renderCalendar(window.currentDate, data.price_info);
            }

            // 3. 호텔 및 골프 정보
            console.log("🏨 Mapping Hotel & Golf...");
            if (data.hotels && data.hotels.length > 0) {
                const hotel = data.hotels[0];
                setValByPlaceholder("예: 다낭 메리어트 리조트", hotel.name_kr || '');
                setValByPlaceholder("호텔 특징 및 수영장, 레스토랑 등 부대시설 입력", hotel.description || '');
                if (hotel.meta_info) {
                    if (hotel.meta_info.check_in_out) {
                        setValByPlaceholder("15:00 / 11:00", hotel.meta_info.check_in_out);
                    }
                    if (hotel.meta_info.website) {
                        setValByPlaceholder("웹사이트/전화번호", hotel.meta_info.website);
                    }
                }
                document.getElementById('hotelInfoSection').classList.remove('hidden');
                console.log(`  ✓ Hotel: ${hotel.name_kr || 'N/A'}`);
            }

            // 골프장 렌더링 (여러 개 지원)
            if (data.golf_courses && data.golf_courses.length > 0) {
                renderGolfCourses(data.golf_courses);
                console.log(`  ✓ Golf Courses: ${data.golf_courses.length}개`);
            }

            // 일정 옵션 렌더링 (기간별 일정)
            if (data.itinerary_options && data.itinerary_options.length > 0) {
                window.allItineraryOptions = data.itinerary_options;
                renderItineraryOptions(data.itinerary_options);
                console.log(`  ✓ Itinerary Options: ${data.itinerary_options.length}개`);
                // 첫 번째 옵션 자동 선택
                if (data.itinerary_options.length > 0) {
                    selectItinerary(0);
                }
            } else {
                // 일정이 없으면 기존 방식으로 타임라인 생성
                generateTimeline();
            }

            // 4. 상세 정보
            if (data.details) {
                if (data.details.inclusions && Array.isArray(data.details.inclusions)) {
                    const inclusionsText = data.details.inclusions.map(item => `- ${item}`).join('\n');
                    setValByPlaceholder("- 왕복 항공권", inclusionsText);
                }
                if (data.details.exclusions && Array.isArray(data.details.exclusions)) {
                    const exclusionsText = data.details.exclusions.map(item => `- ${item}`).join('\n');
                    setValByPlaceholder("- 가이드/기사 경비", exclusionsText);
                }
                const notes = [];
                if (data.details.others) notes.push(data.details.others);
                if (data.details.special_notes && Array.isArray(data.details.special_notes)) {
                    notes.push(data.details.special_notes.join(', '));
                }
                if (notes.length > 0) {
                    setValByPlaceholder("쇼핑 3회, 선택관광 정보 등", notes.join("\n"));
                }
            }

            // 5. 항공 정보
            if (data.flight_info) {
                const airline = data.flight_info.airline || '';
                const flightNumber = data.flight_info.flight_number || '';
                const departureTime = data.flight_info.departure_time || '';
                const fullFlightStr = `${airline} ${flightNumber} ${departureTime} 출발`.trim();
                setValByPlaceholder("예: 대한항공 KE463 18:00 출발", fullFlightStr);
                console.log(`  ✓ Flight: ${fullFlightStr}`);
            }

            // 6. AI 콘텐츠
            if (data.ai_content?.body_text) {
                const editor = document.getElementById('editorBlocks');
                if (editor) {
                    editor.innerHTML = '';
                    const paragraphs = data.ai_content.body_text.split('\n');
                    paragraphs.forEach(p => {
                        if (p.trim()) addTextBlock(p.trim());
                    });
                    console.log(`  ✓ AI Content: ${paragraphs.length} paragraphs added`);
                }
            }

            console.log("✅ All Mapping Completed.");

            // 성공 UI
            if (infoDiv) {
                infoDiv.classList.remove('animate-pulse', 'bg-indigo-50', 'border-indigo-100');
                infoDiv.classList.add('bg-green-50', 'border-green-100');
                statusText.textContent = "분석 완료!";
                statusText.className = "text-xs text-green-600 font-bold";
                statusIcon.setAttribute('data-lucide', 'check-circle');
                statusIcon.classList.remove('animate-spin', 'text-indigo-600');
                statusIcon.classList.add('text-green-600');
                if (window.lucide) lucide.createIcons();
            }

            if (overlay) overlay.classList.add('hidden');

            // 성공 알림
            alert("AI 분석이 완료되었습니다!");

        } else {
            throw new Error("데이터 분석 결과가 비어있습니다.");
        }

    } catch (error) {
        console.error("❌ Analysis Error:", error);
        alert("분석 중 오류가 발생했습니다: " + error.message);

        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.classList.add('hidden');

        const infoDiv = document.getElementById('quotationFileInfo');
        const statusText = document.getElementById('quotationStatusText');
        const statusIcon = document.getElementById('quotationStatusIcon');

        if (infoDiv) {
            infoDiv.classList.remove('animate-pulse', 'bg-indigo-50', 'border-indigo-100');
            infoDiv.classList.add('bg-red-50', 'border-red-100');
            statusText.textContent = "오류 발생";
            statusText.className = "text-xs text-red-600 font-bold";
            statusIcon.setAttribute('data-lucide', 'alert-circle');
            statusIcon.classList.remove('animate-spin', 'text-indigo-600');
            statusIcon.classList.add('text-red-600');
            if (window.lucide) lucide.createIcons();
        }
    }
}

// Helper: Placeholder 텍스트로 input 찾아서 값 설정
function setValByPlaceholder(placeholderPart, value) {
    if (!value) return;
    const inputs = document.querySelectorAll('input, textarea');
    for (const el of inputs) {
        if (el.placeholder && el.placeholder.includes(placeholderPart)) {
            el.value = value;
            return;
        }
    }
}

// ==========================================
// 골프장 렌더링 함수 (여러 개 지원)
// ==========================================
function renderGolfCourses(courses) {
    if (!courses || courses.length === 0) return;

    const container = document.getElementById('golfContainer');
    const template = document.getElementById('golfInfoSection');
    if (!container || !template) return;

    // 기존 골프장 섹션 제거 (템플릿 제외)
    const existingSections = container.querySelectorAll('#golfInfoSection');
    existingSections.forEach((section, index) => {
        if (index > 0) section.remove(); // 첫 번째는 템플릿이므로 유지
    });

    courses.forEach((golf, index) => {
        let section;
        if (index === 0) {
            // 첫 번째는 기존 템플릿 사용
            section = template;
            section.classList.remove('hidden');
        } else {
            // 두 번째부터는 복제
            section = template.cloneNode(true);
            section.id = `golfInfoSection_${index}`;
            container.appendChild(section);
        }

        // 골프장명
        const nameInput = section.querySelector('input[placeholder*="골프장명"]');
        if (nameInput) nameInput.value = golf.name_kr || '';

        // 주소
        const addressInput = section.querySelector('input[placeholder*="주소"]');
        if (addressInput) addressInput.value = golf.address || '';

        // 운영 정보
        const operationInput = section.querySelector('input[placeholder*="운영 정보"]');
        if (operationInput) operationInput.value = golf.operation_info || '';

        // 골프장 설명
        const descTextarea = section.querySelector('textarea[placeholder*="골프장 설명"]');
        if (descTextarea) descTextarea.value = golf.description || '';

        // 홀 정보
        const holeInput = section.querySelector('input[placeholder*="홀 정보"]');
        if (holeInput && golf.meta_info?.hole_info) {
            holeInput.value = golf.meta_info.hole_info;
        }

        // 웹사이트/전화번호
        const websiteInputs = section.querySelectorAll('input');
        for (let inp of websiteInputs) {
            if (inp.placeholder && inp.placeholder.includes("웹사이트/전화번호")) {
                if (golf.meta_info?.website) inp.value = golf.meta_info.website;
                break;
            }
        }
    });
}

// ==========================================
// 일정 옵션 렌더링 함수 (탭/칩 형태)
// ==========================================
function renderItineraryOptions(options) {
    if (!options || options.length === 0) return;

    const container = document.getElementById('itineraryOptions');
    if (!container) return;

    const buttonContainer = container.querySelector('div');
    if (!buttonContainer) return;

    buttonContainer.innerHTML = ''; // 기존 버튼 제거

    options.forEach((option, index) => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'px-4 py-2 rounded-lg font-medium text-sm transition-all itinerary-option-btn';
        button.dataset.index = index;
        button.textContent = option.option_name || `옵션 ${index + 1}`;
        
        // 기본 스타일 (비활성)
        button.classList.add('bg-slate-100', 'text-slate-600', 'hover:bg-slate-200');
        
        // 클릭 이벤트
        button.addEventListener('click', function() {
            selectItinerary(index);
        });

        buttonContainer.appendChild(button);
    });

    // 컨테이너 표시
    container.classList.remove('hidden');
}

// ==========================================
// 일정 옵션 선택 함수
// ==========================================
function selectItinerary(index) {
    if (!window.allItineraryOptions || index < 0 || index >= window.allItineraryOptions.length) {
        console.error('Invalid itinerary option index:', index);
        return;
    }

    const selectedOption = window.allItineraryOptions[index];
    const schedules = selectedOption.schedules || [];

    console.log(`📅 Selected Itinerary: ${selectedOption.option_name} (${schedules.length}일)`);

    // 모든 버튼 스타일 초기화
    document.querySelectorAll('.itinerary-option-btn').forEach(btn => {
        btn.classList.remove('bg-indigo-600', 'text-white', 'shadow-md');
        btn.classList.add('bg-slate-100', 'text-slate-600', 'hover:bg-slate-200');
    });

    // 선택된 버튼 스타일 적용
    const selectedButton = document.querySelector(`.itinerary-option-btn[data-index="${index}"]`);
    if (selectedButton) {
        selectedButton.classList.remove('bg-slate-100', 'text-slate-600', 'hover:bg-slate-200');
        selectedButton.classList.add('bg-indigo-600', 'text-white', 'shadow-md');
    }

    // 타임라인 렌더링
    renderTimeline(schedules);

    // 여행 기간 입력창 자동 업데이트
    // option_name에서 "2박 3일" 같은 패턴 추출
    const optionName = selectedOption.option_name || '';
    const nightMatch = optionName.match(/(\d+)박/);
    const dayMatch = optionName.match(/(\d+)일/);

    if (nightMatch) {
        const nightsInput = document.getElementById('nightsInput');
        if (nightsInput) {
            nightsInput.value = parseInt(nightMatch[1]);
            console.log(`  ✓ Nights updated: ${nightMatch[1]}`);
        }
    }

    if (dayMatch) {
        const daysInput = document.getElementById('daysInput');
        if (daysInput) {
            daysInput.value = parseInt(dayMatch[1]);
            console.log(`  ✓ Days updated: ${dayMatch[1]}`);
        }
    }

    // 스케줄에서 박/일 수 추출 (option_name에 없을 경우)
    if (!nightMatch && schedules.length > 0) {
        const lastDay = schedules[schedules.length - 1];
        const nightsInput = document.getElementById('nightsInput');
        if (nightsInput && lastDay.day) {
            // 마지막 날짜에서 박 수 계산 (예: Day 3이면 2박)
            nightsInput.value = Math.max(1, lastDay.day - 1);
        }
    }

    if (!dayMatch && schedules.length > 0) {
        const lastDay = schedules[schedules.length - 1];
        const daysInput = document.getElementById('daysInput');
        if (daysInput && lastDay.day) {
            daysInput.value = lastDay.day;
        }
    }
}

// ==========================================
// 타임라인 렌더링 함수 (기존 renderItinerary를 rename)
// ==========================================
function renderTimeline(itinerary) {
    if (!itinerary || itinerary.length === 0) return;

    const container = document.getElementById('timelineContainer');
    const template = document.getElementById('daySectionTemplate');
    if (!container || !template) return;

    container.innerHTML = '';

    itinerary.forEach((daySchedule) => {
        const dayNum = daySchedule.day || 1;
        const daySection = template.content.cloneNode(true);
        
        // Day 제목 설정
        const dayTitle = daySection.querySelector('.day-title');
        if (dayTitle) dayTitle.textContent = `Day ${dayNum}`;

        // 이벤트 리스트 설정
        const eventList = daySection.querySelector('.event-list');
        if (eventList) {
            eventList.dataset.day = dayNum;

            // Sortable 초기화
            new Sortable(eventList, {
                group: 'shared',
                animation: 150,
                ghostClass: 'bg-indigo-50',
                handle: '.event-card'
            });

            // 교통편 이벤트 추가
            if (daySchedule.transport || daySchedule.time) {
                const transportCard = createEventCard('transport', {
                    transport: daySchedule.transport,
                    time: daySchedule.time,
                    description: daySchedule.description
                });
                eventList.appendChild(transportCard);
            }

            // 주요 일정 이벤트 추가
            if (daySchedule.description) {
                const descLower = daySchedule.description.toLowerCase();
                let icon = '📝';
                let type = 'other';

                if (descLower.includes('골프') || descLower.includes('라운딩') || descLower.includes('cc')) {
                    icon = '⛳';
                    type = 'golf';
                } else if (descLower.includes('이동') || descLower.includes('출발') || descLower.includes('도착')) {
                    icon = '🚗';
                    type = 'transport';
                } else if (descLower.includes('호텔') || descLower.includes('체크인')) {
                    icon = '🏨';
                    type = 'hotel';
                } else if (descLower.includes('관광') || descLower.includes('투어')) {
                    icon = '📷';
                    type = 'sightseeing';
                }

                const mainCard = createEventCard(type, {
                    description: daySchedule.description
                }, icon);
                eventList.appendChild(mainCard);
            }

            // 식사 정보 추가
            if (daySchedule.meals) {
                const meals = daySchedule.meals;
                const mealItems = [];
                if (meals.breakfast && meals.breakfast !== '불포함') {
                    mealItems.push(`조식: ${meals.breakfast}`);
                }
                if (meals.lunch && meals.lunch !== '불포함') {
                    mealItems.push(`중식: ${meals.lunch}`);
                }
                if (meals.dinner && meals.dinner !== '불포함') {
                    mealItems.push(`석식: ${meals.dinner}`);
                }

                if (mealItems.length > 0) {
                    const mealCard = createEventCard('meal', {
                        description: mealItems.join(', ')
                    });
                    eventList.appendChild(mealCard);
                }
            }
        }

        container.appendChild(daySection);
    });

    // Lucide 아이콘 재생성
    if (window.lucide) lucide.createIcons();
}

// 이벤트 카드 생성 헬퍼 함수
function createEventCard(type, data, customIcon = null) {
    const div = document.createElement('div');
    
    let icon = customIcon;
    let contentHTML = '';

    if (!icon) {
        switch (type) {
            case 'flight':
                icon = '✈️';
                contentHTML = document.getElementById('flightContent')?.innerHTML || '';
                break;
            case 'hotel':
                icon = '🏨';
                contentHTML = document.getElementById('hotelContent')?.innerHTML || '';
                break;
            case 'golf':
                icon = '⛳';
                contentHTML = document.getElementById('golfContent')?.innerHTML || '';
                break;
            case 'sightseeing':
                icon = '📷';
                contentHTML = document.getElementById('hybridContent')?.innerHTML || '';
                break;
            case 'meal':
                icon = '🍽️';
                contentHTML = `<input type="text" class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:border-indigo-500 outline-none" value="${data.description || ''}" readonly>`;
                break;
            case 'transport':
                icon = '🚗';
                contentHTML = `
                    <div class="space-y-2">
                        ${data.transport ? `<div class="text-sm text-slate-600">교통편: ${data.transport}</div>` : ''}
                        ${data.time ? `<div class="text-sm text-slate-600">시간: ${data.time}</div>` : ''}
                        ${data.description ? `<div class="text-sm text-slate-800">${data.description}</div>` : ''}
                    </div>
                `;
                break;
            default:
                icon = '📝';
                contentHTML = `<input type="text" class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:border-indigo-500 outline-none" value="${data.description || ''}" readonly>`;
        }
    } else {
        // 커스텀 아이콘 사용 시
        if (type === 'transport') {
            contentHTML = `
                <div class="space-y-2">
                    ${data.transport ? `<div class="text-sm text-slate-600">교통편: ${data.transport}</div>` : ''}
                    ${data.time ? `<div class="text-sm text-slate-600">시간: ${data.time}</div>` : ''}
                    ${data.description ? `<div class="text-sm text-slate-800">${data.description}</div>` : ''}
                </div>
            `;
        } else {
            contentHTML = `<input type="text" class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:border-indigo-500 outline-none" value="${data.description || ''}" readonly>`;
        }
    }

    div.innerHTML = `
        <div class="event-card group bg-white border border-slate-200 rounded-xl p-4 hover:border-indigo-300 transition-all shadow-sm cursor-move" data-category="${type}">
            <div class="flex items-start gap-3">
                <div class="w-8 h-8 rounded-lg bg-indigo-50 flex items-center justify-center text-lg event-icon">${icon}</div>
                <div class="flex-1 event-content">${contentHTML}</div>
                <button type="button" onclick="this.closest('.event-card').remove()" class="text-slate-300 hover:text-red-500 transition-colors"><i data-lucide="trash-2" size="16"></i></button>
            </div>
        </div>
    `;

    const card = div.firstElementChild;
    const imageGrid = card.querySelector('.card-image-grid');
    if (imageGrid && typeof Sortable !== 'undefined') {
        new Sortable(imageGrid, { animation: 150, ghostClass: 'bg-indigo-50' });
    }

    return card;
}

// ==========================================
// 2. 달력 (일정 시각화) - 고도화 버전
// ==========================================
window.currentDate = new Date();
window.currentPriceData = [];
window.selectedDate = null; // 현재 선택된 날짜 (YYYY-MM-DD)

window.renderCalendar = function(baseDate = window.currentDate, priceData = window.currentPriceData) {
    const year = baseDate.getFullYear();
    const month = baseDate.getMonth();

    const title = document.getElementById('calendarTitle');
    if (title) title.textContent = `${year}년 ${month + 1}월`;

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const grid = document.getElementById('calendarGrid');
    if (!grid) return;
    grid.innerHTML = '';

    // 빈 칸 채우기
    for (let i = 0; i < firstDay.getDay(); i++) {
        grid.appendChild(document.createElement('div'));
    }

    // 날짜 채우기
    for (let d = 1; d <= lastDay.getDate(); d++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const cell = document.createElement('div');
        cell.className = 'aspect-square flex flex-col items-center justify-center rounded-lg text-sm cursor-pointer hover:bg-slate-50 transition-colors border border-transparent';
        cell.dataset.date = dateStr; // 날짜 데이터 속성 추가

        const numSpan = document.createElement('span');
        numSpan.textContent = d;
        cell.appendChild(numSpan);

        // 가격 데이터가 있는 날짜 처리
        if (priceData && priceData.length > 0) {
            const info = priceData.find(p => p.departure_date === dateStr);
            if (info) {
                cell.classList.add('bg-indigo-50', 'border-indigo-100');
                cell.querySelector('span').classList.add('font-bold', 'text-indigo-700');

                // 파란 점 추가
                const priceDot = document.createElement('div');
                priceDot.className = 'w-1.5 h-1.5 bg-indigo-500 rounded-full mt-1';
                cell.appendChild(priceDot);

                // 툴팁 (마우스 오버 시 가격 표시)
                if (info.price_adult) {
                    cell.title = `${Number(info.price_adult).toLocaleString()}원`;
                }

                // 클릭 이벤트 추가
                cell.addEventListener('click', function() {
                    handleDateClick(dateStr, info);
                });
            }
        }

        // 선택된 날짜 표시
        if (window.selectedDate === dateStr) {
            cell.classList.add('ring-2', 'ring-indigo-500', 'ring-offset-2');
        }

        grid.appendChild(cell);
    }
}

// 날짜 클릭 핸들러
function handleDateClick(dateStr, priceInfo) {
    console.log(`📅 Date Clicked: ${dateStr}, Price: ${priceInfo.price_adult ? Number(priceInfo.price_adult).toLocaleString() + '원' : 'N/A'}, Nights: ${priceInfo.night_count || 'N/A'}`);

    // 이전 선택 제거
    document.querySelectorAll('#calendarGrid > div').forEach(cell => {
        cell.classList.remove('ring-2', 'ring-indigo-500', 'ring-offset-2');
    });

    // 현재 선택 표시
    const clickedCell = document.querySelector(`#calendarGrid > div[data-date="${dateStr}"]`);
    if (clickedCell) {
        clickedCell.classList.add('ring-2', 'ring-indigo-500', 'ring-offset-2');
    }

    window.selectedDate = dateStr;
    selectedDateData = priceInfo;

    // 입력 필드 갱신
    if (priceInfo.night_count) {
        document.getElementById('nightsInput').value = priceInfo.night_count;
    }
    if (priceInfo.day_count) {
        document.getElementById('daysInput').value = priceInfo.day_count;
    }

    const priceInputs = document.querySelectorAll('.price-input');
    if (priceInputs.length >= 2 && priceInfo.price_adult) {
        const price = parseInt(priceInfo.price_adult);
        priceInputs[0].value = price.toLocaleString();
        priceInputs[1].value = Math.floor(price * 0.9).toLocaleString();
    }

    // 타임라인 재생성
    generateTimeline();
}

window.changeMonth = function(delta) {
    window.currentDate.setMonth(window.currentDate.getMonth() + delta);
    renderCalendar(window.currentDate, window.currentPriceData);
}

// ==========================================
// 3. UI 유틸리티 (기존 기능 유지)
// ==========================================

const dummyDB = {
    hotel: [
        { name: "하얏트 리젠시 다낭", image: "https://images.unsplash.com/photo-1566073771259-6a8506099945?auto=format&fit=crop&q=80&w=100", desc: "5성급 • 논누옥 비치", loc: "다낭, 베트남" },
        { name: "빈펄 리조트 & 스파", image: "https://images.unsplash.com/photo-1582719508461-905c673771fd?auto=format&fit=crop&q=80&w=100", desc: "5성급 • 프라이빗 풀빌라", loc: "호이안, 베트남" },
    ],
    golf: [
        { name: "다낭 CC", image: "https://images.unsplash.com/photo-1587174486073-ae5e5cff23aa?auto=format&fit=crop&q=80&w=100", desc: "18홀 • 듄스 코스", loc: "다낭" },
    ],
    sightseeing: [
        { name: "바나힐 투어", image: "https://images.unsplash.com/photo-1559592413-7cec4d0cae2b?auto=format&fit=crop&q=80&w=100", desc: "테마파크 • 케이블카", loc: "다낭" },
    ]
};

window.resetItinerary = function() {
    if (confirm('정말로 일정을 초기화하시겠습니까?')) {
        generateTimeline();
    }
}

window.regenerateItinerary = async function() {
    const btn = document.getElementById('regenerateBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin" size="14"></i> 생성 중...';
    if (window.lucide) lucide.createIcons();
    await new Promise(r => setTimeout(r, 1000));
    generateTimeline();
    btn.disabled = false;
    btn.innerHTML = originalText;
    if (window.lucide) lucide.createIcons();
}

window.generateTimeline = function() {
    const daysInput = document.getElementById('daysInput');
    const container = document.getElementById('timelineContainer');
    const days = parseInt(daysInput.value) || 3;
    if (!container) return;

    container.innerHTML = '';
    for (let i = 1; i <= days; i++) {
        const template = document.getElementById('daySectionTemplate').content.cloneNode(true);
        template.querySelector('.day-title').textContent = `Day ${i}`;
        template.querySelector('.event-list').dataset.day = i;

        new Sortable(template.querySelector('.event-list'), {
            group: 'shared',
            animation: 150,
            ghostClass: 'bg-indigo-50',
            handle: '.event-card'
        });
        container.appendChild(template);
    }
    if (window.lucide) lucide.createIcons();
}

window.addEvent = function(btn, type) {
    const selector = btn.closest('.type-selector');
    const daySection = btn.closest('.day-section');
    const eventList = daySection.querySelector('.event-list');
    const div = document.createElement('div');

    let contentHTML = '';
    let icon = '';

    if (type === 'flight') {
        icon = '✈️';
        contentHTML = document.getElementById('flightContent').innerHTML;
    } else if (type === 'hotel') {
        icon = '🏨';
        contentHTML = document.getElementById('hotelContent').innerHTML;
    } else if (type === 'golf') {
        icon = '⛳';
        contentHTML = document.getElementById('golfContent').innerHTML;
    } else if (type === 'sightseeing') {
        icon = '📷';
        contentHTML = document.getElementById('hybridContent').innerHTML;
    } else if (type === 'meal') {
        icon = '🍽️';
        contentHTML = `<input type="text" class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:border-indigo-500 outline-none" placeholder="식사 장소/메뉴 입력">`;
    } else {
        icon = '📝';
        contentHTML = `<input type="text" class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:border-indigo-500 outline-none" placeholder="일정 내용 입력">`;
    }

    div.innerHTML = `
        <div class="event-card group bg-white border border-slate-200 rounded-xl p-4 hover:border-indigo-300 transition-all shadow-sm cursor-move" data-category="${type}">
            <div class="flex items-start gap-3">
                <div class="w-8 h-8 rounded-lg bg-indigo-50 flex items-center justify-center text-lg event-icon">${icon}</div>
                <div class="flex-1 event-content">${contentHTML}</div>
                <button type="button" onclick="this.closest('.event-card').remove()" class="text-slate-300 hover:text-red-500 transition-colors"><i data-lucide="trash-2" size="16"></i></button>
            </div>
        </div>`;

    const card = div.firstElementChild;
    const imageGrid = card.querySelector('.card-image-grid');
    if (imageGrid) new Sortable(imageGrid, { animation: 150, ghostClass: 'bg-indigo-50' });

    eventList.appendChild(card);
    selector.classList.add('hidden');
    if (window.lucide) lucide.createIcons();
}

window.showTypeSelector = function(btn) {
    const selector = btn.nextElementSibling;
    selector.classList.remove('hidden');
    document.querySelectorAll('.type-selector').forEach(el => {
        if (el !== selector) el.classList.add('hidden');
    });
}

document.addEventListener('click', function(e) {
    if (!e.target.closest('.relative')) {
        document.querySelectorAll('.type-selector').forEach(el => el.classList.add('hidden'));
    }
});

window.toggleMode = function(btn) {
    const container = btn.closest('.event-content');
    const searchMode = container.querySelector('.mode-search');
    const manualMode = container.querySelector('.mode-manual');
    if (searchMode.classList.contains('hidden')) {
        searchMode.classList.remove('hidden');
        manualMode.classList.add('hidden');
    } else {
        searchMode.classList.add('hidden');
        manualMode.classList.remove('hidden');
    }
}

window.handleSearch = function(input) {
    const query = input.value.toLowerCase();
    const container = input.closest('.mode-search');
    const resultsDiv = container.querySelector('.search-results');
    const card = input.closest('.event-card');
    const category = card.dataset.category || 'sightseeing';

    if (query.length < 1) { resultsDiv.classList.add('hidden'); return; }

    const data = dummyDB[category] || [];
    const filtered = data.filter(item => item.name.toLowerCase().includes(query));

    resultsDiv.innerHTML = filtered.map(item => `
        <div class="p-3 hover:bg-indigo-50 cursor-pointer flex gap-3 items-center transition-colors"
            onclick='selectItem(this, ${JSON.stringify(item)})'>
            <img src="${item.image}" class="w-10 h-10 rounded object-cover bg-slate-200" />
            <div>
                <div class="font-bold text-slate-800 text-sm">${item.name}</div>
                <div class="text-xs text-slate-500">${item.desc}</div>
            </div>
        </div>
    `).join('');
    resultsDiv.classList.remove('hidden');
}

window.selectItem = function(el, item) {
    const container = el.closest('.mode-search');
    const input = container.querySelector('.search-input');
    const resultsDiv = container.querySelector('.search-results');
    const preview = container.querySelector('.preview-card');

    input.value = item.name;
    resultsDiv.classList.add('hidden');
    preview.querySelector('img').src = item.image;
    preview.querySelector('.preview-name').textContent = item.name;
    preview.querySelector('.preview-desc').textContent = item.desc;
    preview.querySelector('.preview-loc span').textContent = item.loc;
    preview.classList.remove('hidden');
}

window.handleLandFile = function(input) {}
window.clearLandFile = function() {
    document.getElementById('landFile').value = '';
    document.getElementById('landFileInfo').classList.add('hidden');
    selectedPriceFile = null;
}
window.clearQuotationFile = function() {
    document.getElementById('topQuotationInput').value = '';
    document.getElementById('quotationFileInfo').classList.add('hidden');
    selectedProductFile = null;
}

window.handleHeroImages = function(input) {
    const grid = document.getElementById('heroImageGrid');
    const files = Array.from(input.files);
    if (files.length === 0) return;

    files.forEach(file => {
        if (!file.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const div = document.createElement('div');
            div.className = 'relative group aspect-square rounded-xl overflow-hidden border border-slate-200';
            div.innerHTML = `
                <img src="${e.target.result}" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                    <button type="button" onclick="this.closest('div.relative').remove()" class="p-2 bg-white/90 rounded-full text-red-500 hover:bg-white transition-colors">
                        <i data-lucide="trash-2" size="16"></i>
                    </button>
                </div>`;
            grid.appendChild(div);
            if (window.lucide) lucide.createIcons();
        };
        reader.readAsDataURL(file);
    });
    input.value = '';
}

window.handleCardImages = function(input) {
    const grid = input.closest('.grid-cols-1').querySelector('.card-image-grid');
    input.value = '';
}

window.formatPrice = function(input) {
    let value = input.value.replace(/\D/g, '');
    if (value) input.value = parseInt(value).toLocaleString();
}

window.toggleChip = function(label) {
    const container = label.parentElement;
    container.querySelectorAll('label').forEach(l => {
        l.classList.remove('bg-white', 'text-slate-800', 'shadow-sm');
        l.classList.add('text-slate-500');
    });
    label.classList.add('bg-white', 'text-slate-800', 'shadow-sm');
    label.classList.remove('text-slate-500');
}

window.fillAllPolicies = function() {
    document.getElementById('safetyPolicy').value = "- 현지 기상 악화 시 일정이 변경될 수 있습니다.\n- 개인 소지품 분실에 주의하시기 바랍니다.";
    document.getElementById('refundPolicy').value = "- 여행 개시 30일 전까지 통보 시: 계약금 환급\n- 여행 개시 20일 전까지 통보 시: 여행요금의 10% 배상";
}

window.generateAIContent = function() {
    alert("AI 내용 자동 생성 기능은 아직 준비 중입니다.");
}

window.submitForm = async function(status) {
    console.log(`💾 Submit Form Called: status=${status}`);
    
    try {
        // 폼 데이터 수집
        const formData = {
            product_name: document.querySelector('input[placeholder*="상품명"]')?.value || '',
            product_type: document.querySelector('input[name="product_type"]:checked')?.value || 'overseas',
            country: document.querySelector('input[placeholder*="베트남 다낭"]')?.value?.split(' ')[0] || '',
            city: document.querySelector('input[placeholder*="베트남 다낭"]')?.value?.split(' ').slice(1).join(' ') || '',
            departure_port: document.getElementById('departureCity')?.value || '',
            nights: parseInt(document.getElementById('nightsInput')?.value) || null,
            days: parseInt(document.getElementById('daysInput')?.value) || null,
            status: status,
            
            // JSON 필드들
            details: {
                inclusions: document.querySelector('textarea[placeholder*="왕복 항공권"]')?.value?.split('\n').filter(l => l.trim()) || [],
                exclusions: document.querySelector('textarea[placeholder*="가이드/기사 경비"]')?.value?.split('\n').filter(l => l.trim()) || [],
                special_notes: document.querySelector('textarea[placeholder*="쇼핑 3회"]')?.value?.split('\n').filter(l => l.trim()) || []
            },
            
            hotels: collectHotels(),
            golf_courses: collectGolfCourses(),
            itinerary_options: window.allItineraryOptions || [],
            flight_info: {
                airline: document.querySelector('input[placeholder*="대한항공 KE463"]')?.value || ''
            },
            ai_content: {
                body_text: collectEditorContent()
            },
            
            price_info: window.currentPriceData || []
        };
        
        console.log('📤 Sending data to server:', formData);
        
        const response = await fetch('/product/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        console.log('📥 Server response:', result);
        
        if (response.ok && result.status === 'success') {
            alert(`✅ 상품이 ${status === 'draft' ? '임시저장' : '게시'} 되었습니다!\n상품 ID: ${result.product_id}`);
        } else {
            alert(`❌ 저장 실패: ${result.message || 'Unknown error'}`);
        }
        
    } catch (error) {
        console.error('❌ Submit error:', error);
        alert(`❌ 저장 중 오류가 발생했습니다: ${error.message}`);
    }
}

// 호텔 정보 수집 헬퍼 함수
function collectHotels() {
    const hotels = [];
    const hotelSections = document.querySelectorAll('#hotelContainer > section');
    
    hotelSections.forEach(section => {
        if (section.classList.contains('hidden')) return;
        
        const hotel = {
            name_kr: section.querySelector('input[placeholder*="메리어트"]')?.value || '',
            description: section.querySelector('textarea[placeholder*="호텔 특징"]')?.value || '',
            meta_info: {
                check_in_out: section.querySelector('input[placeholder*="15:00"]')?.value || '',
                website: section.querySelector('input[placeholder*="웹사이트/전화번호"]')?.value || ''
            }
        };
        if (hotel.name_kr) hotels.push(hotel);
    });
    
    return hotels;
}

// 골프장 정보 수집 헬퍼 함수
function collectGolfCourses() {
    const golfCourses = [];
    const golfSections = document.querySelectorAll('#golfContainer > section');
    
    golfSections.forEach(section => {
        if (section.classList.contains('hidden')) return;
        
        const golf = {
            name_kr: section.querySelector('input[placeholder*="골프장명"]')?.value || '',
            address: section.querySelector('input[placeholder*="주소"]')?.value || '',
            operation_info: section.querySelector('input[placeholder*="운영 정보"]')?.value || '',
            description: section.querySelector('textarea[placeholder*="골프장 설명"]')?.value || '',
            meta_info: {
                hole_info: section.querySelector('input[placeholder*="홀 정보"]')?.value || ''
            }
        };
        if (golf.name_kr) golfCourses.push(golf);
    });
    
    return golfCourses;
}

// 에디터 콘텐츠 수집 헬퍼 함수
function collectEditorContent() {
    const blocks = document.querySelectorAll('#editorBlocks > .editor-block');
    const paragraphs = [];
    
    blocks.forEach(block => {
        const textarea = block.querySelector('textarea');
        if (textarea && textarea.value.trim()) {
            paragraphs.push(textarea.value.trim());
        }
    });
    
    return paragraphs.join('\n\n');
}

const editorBlocks = document.getElementById('editorBlocks');
const textBlockTemplate = document.getElementById('textBlockTemplate');
const imageBlockTemplate = document.getElementById('imageBlockTemplate');
if (editorBlocks && typeof Sortable !== 'undefined') {
    new Sortable(editorBlocks, { animation: 150, handle: '.editor-block', ghostClass: 'bg-indigo-50' });
}

window.addTextBlock = function(content = '') {
    const clone = textBlockTemplate.content.cloneNode(true);
    if (content) clone.querySelector('textarea').value = content;
    editorBlocks.appendChild(clone);
    if (window.lucide) lucide.createIcons();
}

window.addImageBlock = function() {
    const clone = imageBlockTemplate.content.cloneNode(true);
    if (clone.querySelector('.image-grid')) {
        new Sortable(clone.querySelector('.image-grid'), { animation: 150, ghostClass: 'bg-indigo-50' });
    }
    editorBlocks.appendChild(clone);
    if (window.lucide) lucide.createIcons();
}

window.addImagesToBlock = function(input) {
    const block = input.closest('.editor-block');
    const grid = block.querySelector('.image-grid');
    const files = Array.from(input.files);
    
    files.forEach(file => {
        if (!file.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const div = document.createElement('div');
            div.className = 'relative group aspect-square rounded-lg overflow-hidden border border-slate-200';
            div.innerHTML = `
                <img src="${e.target.result}" class="w-full h-full object-cover">
                <button type="button" onclick="this.closest('div').remove()" 
                    class="absolute top-1 right-1 p-1 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                    <i data-lucide="x" size="12"></i>
                </button>`;
            grid.appendChild(div);
            if (window.lucide) lucide.createIcons();
        };
        reader.readAsDataURL(file);
    });
    input.value = '';
}

window.removeBlock = function(btn) { 
    btn.closest('.editor-block').remove(); 
}

// [초기화]
renderCalendar();
generateTimeline();
if (window.lucide) lucide.createIcons();
</script>
{% endblock %}


