<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê´€ë¦¬ì ì±„íŒ… í…ŒìŠ¤íŠ¸ (Kafka Ver)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: 'Malgun Gothic', sans-serif; display: flex; height: 100vh; background-color: #f0f2f5; }

        /* ì™¼ìª½: ì±„íŒ…ë°© ëª©ë¡ */
        .sidebar { width: 300px; background-color: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #eee; background-color: #3b82f6; color: white; }
        .sidebar-header h2 { margin: 0; font-size: 18px; }
        .refresh-btn { margin-top: 10px; width: 100%; padding: 8px; background: rgba(255,255,255,0.2); border: none; color: white; cursor: pointer; }

        .room-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .room-item { padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.2s; }
        .room-item:hover { background-color: #f8fafc; }
        .room-item.active { background-color: #eff6ff; border-left: 4px solid #3b82f6; }
        .room-name { font-weight: bold; font-size: 14px; margin-bottom: 5px; }
        .room-id { font-size: 12px; color: #888; }

        /* ì˜¤ë¥¸ìª½: ì±„íŒ…ì°½ */
        .chat-area { flex: 1; display: flex; flex-direction: column; background-color: #eef2f6; }
        .chat-header { padding: 15px 20px; background-color: white; border-bottom: 1px solid #ddd; font-weight: bold; }

        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }

        /* ë©”ì‹œì§€ ë§í’ì„  ìŠ¤íƒ€ì¼ */
        .msg-row { display: flex; width: 100%; }
        .msg-row.admin { justify-content: flex-end; }
        .msg-row.customer { justify-content: flex-start; }

        .bubble { max-width: 60%; padding: 10px 15px; border-radius: 15px; font-size: 14px; line-height: 1.5; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg-row.admin .bubble { background-color: #3b82f6; color: white; border-top-right-radius: 2px; }
        .msg-row.customer .bubble { background-color: white; color: #333; border-top-left-radius: 2px; }
        .msg-info { font-size: 10px; margin-top: 4px; opacity: 0.7; text-align: right; }

        /* ì…ë ¥ì°½ */
        .input-area { padding: 20px; background-color: white; border-top: 1px solid #ddd; display: flex; gap: 10px; }
        #msg-input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        #msg-input:focus { border-color: #3b82f6; }
        .send-btn { padding: 0 20px; background-color: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .send-btn:hover { background-color: #2563eb; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>ìƒë‹´ ëŒ€ê¸° ëª©ë¡</h2>
            <button class="refresh-btn" onclick="loadRooms()">ğŸ”„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <ul id="room-list" class="room-list">
            </ul>
    </div>

    <div class="chat-area">
        <div id="current-room-header" class="chat-header">
            ì±„íŒ…ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.
        </div>
        <div id="messages" class="messages">
            </div>
        <div class="input-area">
            <input type="text" id="msg-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (Enter)" onkeypress="handleKeyPress(event)" disabled>
            <button class="send-btn" onclick="sendAdminMessage()" id="send-btn" disabled>ì „ì†¡</button>
        </div>
    </div>

    <script>
        const socket = io(); // ì†Œì¼“ ì—°ê²° ì‹œì‘
        let currentRoom = null;

        // =========================================
        // 1. ì†Œì¼“ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        // =========================================
        socket.on('connect', () => {
            console.log("âœ… ê´€ë¦¬ì ì†Œì¼“ ì—°ê²° ì„±ê³µ!");
        });

        // [í•µì‹¬] Kafka -> Server -> Admin ìœ¼ë¡œ ë©”ì‹œì§€ê°€ ë„ì°©í–ˆì„ ë•Œ
        socket.on('new_message', (data) => {
            console.log("ğŸ“© ìƒˆ ë©”ì‹œì§€ ìˆ˜ì‹ :", data);

            // í˜„ì¬ ë³´ê³  ìˆëŠ” ë°©ì˜ ë©”ì‹œì§€ë¼ë©´ í™”ë©´ì— ì¦‰ì‹œ í‘œì‹œ
            if (data.room_id === currentRoom) {
                // DBì˜ role ì»¬ëŸ¼ê³¼ Socketì˜ sender_typeì„ ëª¨ë‘ ê³ ë ¤
                const sender = data.sender_type || data.role;
                const text = data.message || data.text;
                appendBubble(sender, text, data.timestamp);
            } else {
                // ë‹¤ë¥¸ ë°©ì—ì„œ ì™”ë‹¤ë©´ ì•Œë¦¼ (ì—¬ê¸°ì„  ì½˜ì†”ë¡œê·¸ë§Œ)
                console.log(`ğŸ”” ì•Œë¦¼: ${data.room_id} ë°©ì—ì„œ ìƒˆ ë©”ì‹œì§€ê°€ ìˆìŠµë‹ˆë‹¤.`);
            }
        });

        // =========================================
        // 2. API í˜¸ì¶œ í•¨ìˆ˜ (ë°© ëª©ë¡ & íˆìŠ¤í† ë¦¬)
        // =========================================

        // ì±„íŒ…ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadRooms() {
            try {
                // [ìˆ˜ì •ë¨] /api/admin/rooms í˜¸ì¶œ
                const res = await axios.get('/api/admin/rooms');
                const list = document.getElementById('room-list');
                list.innerHTML = '';

                if (res.data.length === 0) {
                    list.innerHTML = '<li style="padding:20px; text-align:center; color:#888;">ëŒ€ê¸° ì¤‘ì¸ ìƒë‹´ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                    return;
                }

                res.data.forEach(room => {
                    const li = document.createElement('li');
                    li.className = 'room-item';
                    // í˜„ì¬ ì„ íƒëœ ë°©ì´ë©´ active í´ë˜ìŠ¤ ì¶”ê°€
                    if(room.session_id === currentRoom) li.classList.add('active');

                    li.innerHTML = `
                        <div class="room-name">${room.user_name || 'ìµëª… ê³ ê°'}</div>
                        <div class="room-id">${room.session_id}</div>
                    `;
                    li.onclick = () => joinRoom(room.session_id, room.user_name);
                    list.appendChild(li);
                });
            } catch (err) {
                console.error("ë°© ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:", err);
                alert("ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // ë°© ì…ì¥í•˜ê¸°
        async function joinRoom(roomId, userName) {
            currentRoom = roomId;

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('current-room-header').innerText = `ğŸ’¬ ${userName || 'ê³ ê°'}ë‹˜ê³¼ì˜ ìƒë‹´ (${roomId})`;
            document.getElementById('msg-input').disabled = false;
            document.getElementById('send-btn').disabled = false;
            document.getElementById('messages').innerHTML = ''; // ê¸°ì¡´ ë©”ì‹œì§€ ì´ˆê¸°í™”

            // ë°© ëª©ë¡ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ (ì„ íƒëœ ê²ƒ í‘œì‹œ)
            document.querySelectorAll('.room-item').forEach(el => el.classList.remove('active'));
            // (ê°„ë‹¨ êµ¬í˜„ì„ ìœ„í•´ ì—¬ê¸°ì„  ìƒëµ, ì‹¤ì œë¡  ëª©ë¡ ë‹¤ì‹œ ê·¸ë¦¬ì§€ ì•Šê³  í´ë˜ìŠ¤ë§Œ í† ê¸€ ì¶”ì²œ)

            // 1. ì†Œì¼“ ë°© ì…ì¥ (ì„œë²„ì— ì•Œë¦¼)
            socket.emit('join', { room_id: roomId, user_type: 'admin' });

            // 2. ê¸°ì¡´ ëŒ€í™” ë‚´ì—­ ê°€ì ¸ì˜¤ê¸° (API í˜¸ì¶œ)
            try {
                // [ìˆ˜ì •ë¨] /api/admin/history í˜¸ì¶œ
                const res = await axios.get(`/api/admin/history/${roomId}`);
                res.data.forEach(msg => {
                    // DBì—ëŠ” role/textë¡œ ì €ì¥ë˜ì–´ ìˆìŒ
                    appendBubble(msg.role, msg.text, msg.timestamp);
                });
                scrollToBottom();
            } catch (err) {
                console.error("ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:", err);
            }
        }

        // =========================================
        // 3. ë©”ì‹œì§€ ì „ì†¡ ë° UI ì²˜ë¦¬
        // =========================================

        function sendAdminMessage() {
            const input = document.getElementById('msg-input');
            const msg = input.value.trim();

            if (!currentRoom || !msg) return;

            // [í•µì‹¬] ì„œë²„ë¡œ ë©”ì‹œì§€ ì „ì†¡ (-> DBì €ì¥ -> Kafka -> Client)
            socket.emit('send_message', {
                room_id: currentRoom,
                sender_type: 'admin',    // ê´€ë¦¬ìê°€ ë³´ëƒ„
                message: msg,
                user_name: 'ìƒë‹´ì›'      // í‘œì‹œë  ì´ë¦„
            });

            input.value = '';
            input.focus();

            // ì£¼ì˜: ì—¬ê¸°ì„œ appendBubbleì„ í˜¸ì¶œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!
            // Kafkaë¥¼ ëŒì•„ì„œ 'new_message' ì´ë²¤íŠ¸ê°€ ì˜¤ë©´ ê·¸ë•Œ í™”ë©´ì— ê·¸ë¦½ë‹ˆë‹¤. (í™•ì‹¤í•œ ì „ì†¡ í™•ì¸)
        }

        function appendBubble(sender, text, time) {
            const box = document.getElementById('messages');
            const row = document.createElement('div');

            // senderê°€ 'admin'ì´ë©´ ì˜¤ë¥¸ìª½, ê·¸ ì™¸(customer, ai)ëŠ” ì™¼ìª½
            const isAdmin = sender === 'admin';
            row.className = `msg-row ${isAdmin ? 'admin' : 'customer'}`;

            const timeStr = time ? new Date(time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';

            row.innerHTML = `
                <div class="bubble">
                    ${isAdmin ? '' : `<div style="font-weight:bold; margin-bottom:4px; font-size:11px;">${sender}</div>`}
                    ${text}
                    <div class="msg-info">${timeStr}</div>
                </div>
            `;

            box.appendChild(row);
            scrollToBottom();
        }

        function scrollToBottom() {
            const box = document.getElementById('messages');
            box.scrollTop = box.scrollHeight;
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') sendAdminMessage();
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        loadRooms();
    </script>
</body>
</html>