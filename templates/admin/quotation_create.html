{% extends "admin/base.html" %}

{% block content %}
<div class="h-[calc(100vh-6rem)] flex flex-col">
    <!-- Header -->
    <div class="flex items-center justify-between mb-4 flex-none">
        <div>
            <h1 class="text-2xl font-bold text-slate-900">견적서 작성 (AI Assisted)</h1>
            <p class="text-slate-500 text-sm">AI 분석 데이터를 기반으로 견적서를 작성합니다.</p>
        </div>
        <div class="flex gap-3">
            <button onclick="loadMockData()"
                class="px-4 py-2 bg-indigo-50 text-indigo-600 font-medium hover:bg-indigo-100 rounded-lg transition-colors flex items-center gap-2">
                <i data-lucide="sparkles" size="18"></i>
                ✨ AI 초안 불러오기
            </button>
            <div class="h-6 w-px bg-slate-300 my-auto mx-2"></div>
            <button class="px-4 py-2 text-slate-600 font-medium hover:bg-slate-100 rounded-lg transition-colors">
                미리보기
            </button>
            <button
                class="px-6 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-medium shadow-sm flex items-center gap-2">
                <i data-lucide="save" size="18"></i>
                저장 및 발송
            </button>
        </div>
    </div>

    <!-- Main Content (2-Column Split View) -->
    <div class="grid grid-cols-12 gap-6 flex-1 min-h-0">

        <!-- Left Panel: Source Viewer (40%) -->
        <div
            class="col-span-5 flex flex-col bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden h-full">
            <!-- Tabs -->
            <div class="flex border-b border-slate-200 flex-none">
                <button onclick="switchTab('customer')" id="tab-customer"
                    class="flex-1 px-4 py-3 text-sm font-medium text-primary-600 border-b-2 border-primary-600 bg-primary-50 transition-colors">
                    고객 요청 (Customer Request)
                </button>
                <button onclick="switchTab('supplier')" id="tab-supplier"
                    class="flex-1 px-4 py-3 text-sm font-medium text-slate-500 hover:text-slate-700 transition-colors">
                    랜드사 견적 (Supplier Quote)
                </button>
            </div>

            <!-- Content Area -->
            <div class="p-6 overflow-y-auto flex-1 bg-gray-50">
                <!-- Customer Request Tab -->
                <div id="content-customer" class="space-y-4">
                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                        <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2">
                            <i data-lucide="message-circle" size="16" class="text-yellow-500"></i>
                            카카오톡 대화 요약
                        </h3>
                        <p class="text-sm text-slate-600 leading-relaxed">
                            "안녕하세요, 12월 말쯤 다낭으로 가족 여행 계획 중입니다.
                            성인 2명, 아이 2명이고요.
                            숙소는 좀 좋은 곳으로 하고 싶고, 아이들이 있어서 너무 빡빡한 일정은 피하고 싶어요.
                            쇼핑은 최소화해주시고, 맛집 위주로 부탁드립니다."
                        </p>
                    </div>

                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                        <h3 class="font-bold text-slate-800 mb-2">핵심 요구사항</h3>
                        <ul class="list-disc list-inside text-sm text-slate-600 space-y-1">
                            <li><span class="font-medium text-slate-800">인원:</span> 성인 2, 아동 2 (총 4명)</li>
                            <li><span class="font-medium text-slate-800">목적지:</span> 베트남 다낭</li>
                            <li><span class="font-medium text-slate-800">일정:</span> 12월 말 (3박 5일 예상)</li>
                            <li><span class="font-medium text-slate-800">선호:</span> 고급 숙소, 여유로운 일정, 맛집 투어</li>
                            <li><span class="font-medium text-slate-800">비선호:</span> 과도한 쇼핑</li>
                        </ul>
                    </div>
                </div>

                <!-- Supplier Quote Tab -->
                <div id="content-supplier" class="hidden space-y-4">
                    <div
                        class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm font-mono text-sm text-slate-600">
                        <p class="mb-2 font-bold text-slate-800">[From: 다낭 현지 소장님]</p>
                        <p class="whitespace-pre-wrap">
                            RE: 다낭 프리미엄 가족팀 견적 요청

                            1. 호텔: 하얏트 리젠시 다낭 (오션뷰)
                            - 3박 @ $350 = $1,050

                            2. 차량: 단독 16인승 리무진
                            - 3일 @ $150 = $450

                            3. 가이드: 한국어 가능 베테랑
                            - 3일 @ $100 = $300

                            4. 식사:
                            - 현지식 특식 3회 ($20/인)
                            - 호텔식 1회 ($40/인)
                            - 총 $320

                            5. 입장료 및 기타: $200

                            Total Net: $2,320 (4인 기준)
                            1인당 약 $580
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Editor Form (60%) -->
        <div class="col-span-7 flex flex-col h-full overflow-hidden">
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm flex-1 overflow-y-auto p-6 space-y-8">

                <!-- Customer Info -->
                <section>
                    <h2 class="text-lg font-bold text-slate-900 mb-4 pb-2 border-b border-slate-100">1. 고객 정보</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-slate-700">고객명</label>
                            <input type="text" id="customer_name"
                                class="w-full px-3 py-2 border border-slate-200 rounded-lg transition-colors"
                                placeholder="홍길동" />
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-slate-700">연락처</label>
                            <input type="text" id="phone"
                                class="w-full px-3 py-2 border border-slate-200 rounded-lg transition-colors"
                                placeholder="010-1234-5678" />
                        </div>
                    </div>
                </section>

                <!-- Product Info -->
                <section>
                    <h2 class="text-lg font-bold text-slate-900 mb-4 pb-2 border-b border-slate-100">2. 상품 정보</h2>
                    <div class="space-y-4">
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-slate-700">상품명</label>
                            <input type="text" id="product_name"
                                class="w-full px-3 py-2 border border-slate-200 rounded-lg transition-colors"
                                placeholder="상품명을 입력하세요" />
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-slate-700">항공 정보</label>
                            <input type="text" id="flight_info"
                                class="w-full px-3 py-2 border border-slate-200 rounded-lg transition-colors"
                                placeholder="항공편 정보를 입력하세요" />
                        </div>
                    </div>
                </section>

                <!-- Items Table (Margin Calculator) -->
                <section>
                    <div class="flex items-center justify-between mb-4 pb-2 border-b border-slate-100">
                        <h2 class="text-lg font-bold text-slate-900">3. 견적 상세 (마진금액 계산)</h2>
                        <div class="flex flex-col gap-2">
                            <div
                                class="flex items-center gap-4 bg-slate-50 px-4 py-2 rounded-lg border border-slate-200">
                                <div class="flex items-center gap-2">
                                    <span class="text-sm font-medium text-slate-600">항목별 마진금액:</span>
                                    <input type="text" id="global_margin_amount" value="0"
                                        onchange="updateMarginFromAmount()"
                                        class="w-32 px-2 py-1 text-right border border-slate-300 rounded text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                                        placeholder="0" />
                                    <span class="text-sm text-slate-500">원</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-sm" id="itemsTable">
                            <thead class="bg-slate-50 border-b border-slate-200">
                                <tr>
                                    <th class="px-3 py-2 text-left font-medium text-slate-500 w-1/3">항목명</th>
                                    <th class="px-3 py-2 text-center font-medium text-slate-500 w-16">수량</th>
                                    <th class="px-3 py-2 text-right font-medium text-slate-500">원가 (Net)</th>
                                    <th class="px-3 py-2 text-right font-medium text-slate-500">판매가 (Gross)</th>
                                    <th class="px-3 py-2 text-right font-medium text-slate-500">합계</th>
                                    <th class="px-3 py-2 text-center font-medium text-slate-500 w-10"></th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100" id="itemsTableBody">
                            </tbody>
                            <tfoot class="bg-slate-50 font-bold text-slate-900">
                                <tr>
                                    <td colspan="4" class="px-3 py-3 text-right">총 합계</td>
                                    <td class="px-3 py-3 text-right text-primary-600 text-lg" id="totalAmount">₩0</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <button onclick="addItem()"
                        class="mt-3 text-sm text-primary-600 font-medium hover:underline flex items-center gap-1">
                        <i data-lucide="plus" size="16"></i> 항목 추가
                    </button>
                </section>

                <script>
                    // 숫자 포맷팅 유틸리티
                    function parseNumber(value) {
                        if (!value) return 0;
                        const str = String(value).replace(/,/g, "");
                        return parseFloat(str) || 0;
                    }

                    function formatNumber(num) {
                        return Math.floor(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                    }

                    // 입력값 변경 시 호출
                    function handleInput(input) {
                        const val = parseNumber(input.value);
                        input.value = formatNumber(val);
                        updateCalculation();
                    }

                    // 마진금액 변경 시 호출
                    function updateMarginFromAmount() {
                        const marginInput = document.getElementById('global_margin_amount');
                        handleInput(marginInput);
                    }

                    // 전체 계산 로직 (항목별 마진 적용)
                    function updateCalculation() {
                        const rows = document.querySelectorAll('#itemsTableBody tr');
                        const unitMargin = parseNumber(document.getElementById('global_margin_amount').value);

                        let grandTotal = 0;

                        rows.forEach(row => {
                            const qty = parseNumber(row.querySelector('.qty-input').value);
                            const netUnit = parseNumber(row.querySelector('.net-input').value);

                            if (qty === 0) return;

                            // 판매가(Gross) = 원가(Net) + 마진금액(Unit Margin)
                            const grossUnit = netUnit + unitMargin;

                            // 합계 = 판매가 * 수량
                            const rowTotal = grossUnit * qty;

                            // 화면 표시 업데이트 (3번 인덱스: 판매가, 4번 인덱스: 합계)
                            const tds = row.querySelectorAll('td');
                            if (tds[3]) tds[3].innerText = formatNumber(grossUnit);
                            if (tds[4]) tds[4].innerText = "₩" + formatNumber(rowTotal);

                            grandTotal += rowTotal;
                        });

                        // 총 합계 업데이트
                        document.getElementById('totalAmount').innerText = "₩" + formatNumber(grandTotal);
                    }

                    // 항목 추가 함수
                    function addItem(data = null) {
                        const tbody = document.getElementById('itemsTableBody');
                        const tr = document.createElement('tr');

                        const name = data ? data.name : '';
                        const qty = data ? data.qty : 1;
                        const cost = data ? data.cost_price : 0;

                        tr.innerHTML = `
                            <td class="px-3 py-2">
                                <input type="text" class="w-full border border-slate-300 rounded px-2 py-1 text-sm" placeholder="상품명" value="${name}">
                            </td>
                            <td class="px-3 py-2 text-center">
                                <input type="text" class="qty-input w-full border border-slate-300 rounded px-2 py-1 text-center text-sm" value="${qty}" oninput="handleInput(this)">
                            </td>
                            <td class="px-3 py-2 text-right">
                                <input type="text" class="net-input w-full border border-slate-300 rounded px-2 py-1 text-right text-sm" value="${formatNumber(cost)}" oninput="handleInput(this)">
                            </td>
                            <td class="px-3 py-2 text-right font-medium text-slate-700 text-sm">0</td>
                            <td class="px-3 py-2 text-right font-bold text-slate-900 text-sm">0</td>
                            <td class="px-3 py-2 text-center">
                                <button onclick="this.closest('tr').remove(); updateCalculation()" class="text-slate-400 hover:text-red-500">x</button>
                            </td>
                        `;
                        tbody.appendChild(tr);

                        // Initial calculation for this row
                        updateCalculation();
                    }

                    // AI Mock Data Loading
                    function loadMockData() {
                        const mockData = {
                            "customer_name": "홍길동",
                            "phone": "010-1234-5678",
                            "product_name": "다낭 프리미엄 가족 패키지 (3박 5일)",
                            "flight_info": "KE463 (09:00 출발) / KE464 (23:00 도착)",
                            "items": [
                                { "name": "성인 기본 상품가", "qty": 2, "cost_price": 1000000 },
                                { "name": "아동 기본 상품가", "qty": 2, "cost_price": 800000 }
                            ]
                        };

                        // Fill Form Fields
                        const fields = ['customer_name', 'phone', 'product_name', 'flight_info'];
                        fields.forEach(field => {
                            const el = document.getElementById(field);
                            if (el) {
                                el.value = mockData[field];
                                el.classList.add('bg-blue-50'); // Visual Cue
                            }
                        });

                        // Clear existing items
                        document.getElementById('itemsTableBody').innerHTML = '';

                        // Add Items
                        mockData.items.forEach(item => {
                            addItem(item);
                        });

                        // Show toast or notification (optional)
                        alert('AI가 분석한 데이터를 불러왔습니다.');
                    }

                    // Initialize with one empty row
                    document.addEventListener('DOMContentLoaded', () => {
                        addItem();
                    });
                </script>

                <!-- Additional Info -->
                <section>
                    <h2 class="text-lg font-bold text-slate-900 mb-4 pb-2 border-b border-slate-100">4. 기타 사항</h2>
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-slate-700">비고</label>
                        <textarea class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm transition-colors"
                            rows="3" placeholder="추가 안내사항"></textarea>
                    </div>
                </section>

            </div>
        </div>
    </div>
</div>

<script>
    // Tab Switching Logic
    function switchTab(tabName) {
        const tabs = ['customer', 'supplier'];

        tabs.forEach(t => {
            const btn = document.getElementById(`tab-${t}`);
            const content = document.getElementById(`content-${t}`);

            if (t === tabName) {
                btn.classList.remove('text-slate-500', 'border-transparent');
                btn.classList.add('text-primary-600', 'border-primary-600', 'bg-primary-50');
                content.classList.remove('hidden');
            } else {
                btn.classList.add('text-slate-500', 'border-transparent');
                btn.classList.remove('text-primary-600', 'border-primary-600', 'bg-primary-50');
                content.classList.add('hidden');
            }
        });
    }
</script>
{% endblock %}