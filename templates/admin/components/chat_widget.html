<div id="guest-chat-widget" class="fixed bottom-6 right-6 z-50 flex flex-col items-end">
    <!-- Chat Button -->
    <button id="guestChatToggle"
        class="w-14 h-14 bg-indigo-600 rounded-full shadow-lg flex items-center justify-center text-white hover:bg-indigo-700 transition-all hover:scale-110 focus:outline-none">
        <i class="fas fa-comment-dots text-2xl"></i>
    </button>

    <!-- Chat Container -->
    <div id="guestChatContainer"
        class="hidden mt-4 w-80 bg-white rounded-2xl shadow-2xl overflow-hidden border border-gray-100 flex flex-col transition-all origin-bottom-right transform scale-95 opacity-0 pb-20 sm:pb-0"
        style="height: 500px; max-height: 80vh;">
        <!-- Header -->
        <div class="bg-indigo-600 p-4 text-white flex justify-between items-center shadow-md shrink-0">
            <div class="flex items-center gap-2">
                <i class="fas fa-robot"></i>
                <span class="font-bold">?¬í ?ë´ ë´?/span>
            </div>
            <button id="guestChatClose" class="text-white hover:text-indigo-200">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Messages Area -->
        <div id="guestChatMessages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50">
            <div class="flex justify-start animate-fade-in-up">
                <div
                    class="bg-white border border-gray-200 p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-gray-800">
                    ?ë?ì¸?? ë¬´ì???ì??ë¦´ê¹ì?
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-3 bg-white border-t border-gray-100 shrink-0">
            <div
                class="flex bg-gray-100 rounded-full px-4 py-2 focus-within:ring-2 focus-within:ring-indigo-100 transition-all">
                <input type="text" id="guestChatInput" placeholder="ë©ìì§ ?ë ¥..."
                    class="flex-1 bg-transparent border-none focus:ring-0 text-sm outline-none">
                <button id="guestChatSend" class="text-indigo-600 hover:text-indigo-800 pl-2">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        // 1. Session & UUID Logic (Future Proofing)
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        let sessionId = localStorage.getItem('chat_session_id');
        if (!sessionId) {
            sessionId = generateUUID();
            localStorage.setItem('chat_session_id', sessionId);
        }

        // Simple Guest Name
        const userName = 'Guest-' + sessionId.substring(0, 4);

        // 2. UI Logic
        const toggleBtn = document.getElementById('guestChatToggle');
        const closeBtn = document.getElementById('guestChatClose');
        const container = document.getElementById('guestChatContainer');
        const messagesArea = document.getElementById('guestChatMessages');
        const input = document.getElementById('guestChatInput');
        const sendBtn = document.getElementById('guestChatSend');

        function toggleChat() {
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                requestAnimationFrame(() => {
                    container.classList.remove('scale-95', 'opacity-0');
                });
            } else {
                container.classList.add('scale-95', 'opacity-0');
                setTimeout(() => container.classList.add('hidden'), 200);
            }
        }

        toggleBtn.addEventListener('click', toggleChat);
        closeBtn.addEventListener('click', toggleChat);

        // 3. Send Message Logic
        async function sendMessage() {
            const text = input.value.trim();
            if (!text) return;

            // Append User Message
            appendMessage(text, 'user');
            input.value = '';

            // Prepare Payload
            const payload = {
                message: text,
                session_id: sessionId,
                user_type: 'guest',
                user_name: userName
            };

            // Add Loading
            const loadingId = appendLoading();

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                // Remove Loading
                const loader = document.getElementById(loadingId);
                if (loader) loader.remove();

                // Append Bot Response
                appendMessage(data.reply, 'bot');

            } catch (err) {
                console.error(err);
                const loader = document.getElementById(loadingId);
                if (loader) loader.remove();
                appendMessage('?¤ë¥ê° ë°ì?ìµ?ë¤.', 'bot');
            }
        }

        function appendMessage(text, sender) {
            const div = document.createElement('div');
            div.className = `flex w-full ${sender === 'user' ? 'justify-end' : 'justify-start'} animate-fade-in-up`;

            const inner = sender === 'user'
                ? `<div class="bg-indigo-600 text-white p-3 rounded-2xl rounded-tr-none shadow-md text-sm max-w-[80%]">${text}</div>`
                : `<div class="bg-white border border-gray-200 p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-gray-800 max-w-[80%]">${text}</div>`;

            div.innerHTML = inner;
            messagesArea.appendChild(div);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        function appendLoading() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'flex justify-start animate-fade-in-up';
            div.innerHTML = `<div class="bg-white border border-gray-200 p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-gray-400">...</div>`;
            messagesArea.appendChild(div);
            messagesArea.scrollTop = messagesArea.scrollHeight;
            return id;
        }

        sendBtn.addEventListener('click', sendMessage);
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

    })();
</script>
